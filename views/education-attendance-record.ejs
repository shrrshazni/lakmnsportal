<%- include("partials/private-header.ejs") %>

<style>
  .card-icon {
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    font-size: 2rem;
  }

  /* Custom checkbox styling */
  .attendance-checkbox-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .attendance-checkbox-wrapper label {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    margin-right: 10px;
    font-size: 14px;
  }

  .attendance-checkbox {
    display: none;
  }

  .custom-checkbox {
    position: relative;
    width: 16px;
    /* Reduced size */
    height: 16px;
    /* Reduced size */
    border: 2px solid #d1d1d1;
    border-radius: 3px;
    display: inline-block;
    margin-right: 8px;
    transition: all 0.2s ease;
  }

  /* Blue hover effect before checkbox is clicked */
  .attendance-checkbox:not(:disabled)+.custom-checkbox:hover {
    border-color: #2196F3;
    /* Blue hover color */
  }

  /* Green and red styles for present/absent */
  .custom-checkbox:before {
    content: '';
    position: absolute;
    width: 8px;
    /* Adjusted size */
    height: 8px;
    /* Adjusted size */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background-color: transparent;
    border-radius: 2px;
    transition: transform 0.3s ease;
  }

  .custom-checkbox.checked-green:before {
    background-color: #4caf50;
    /* Green for present */
    transform: translate(-50%, -50%) scale(1);
  }

  .custom-checkbox.checked-red:before {
    background-color: #f44336;
    /* Red for absent */
    transform: translate(-50%, -50%) scale(1);
  }

  /* Disabled checkbox styles */
  .attendance-checkbox:disabled+.custom-checkbox {
    border-color: #aaa;
    background-color: #e0e0e0;
  }

  /* Disabled state hover removal */
  .attendance-checkbox:disabled+.custom-checkbox:hover {
    border-color: #aaa;
    /* No hover effect for disabled checkboxes */
  }

  /* Label styles */
  .attendance-checkbox-wrapper label {
    color: #555;
  }

  .attendance-checkbox:disabled+.custom-checkbox+label {
    color: #aaa;
    /* Grey out the text when disabled */
  }

  /* Media query for responsive */
  @media (max-width: 768px) {
    .filters {
      flex-direction: column;
    }
  }
</style>

<div class="row gy-3 mb-3 justify-content-between d-flex mt-0">
  <div class="col-md-9 col-auto">
    <h2 class="mb-2 text-body-emphasis">Attendance Record</h2>
    <h5 class="text-body-tertiary fw-semibold">We hope you have a great experience managing visitor entries and exits.</h5>
  </div>

  <!-- Student info button -->
  <div class="col-md-3 col-auto d-flex align-items-center justify-content-end">
    <div class="col-auto">
      <a class="btn btn-phoenix-primary" role="button" href="/education/student/information">Student Info</a>
    </div>
  </div>
</div>

<div class="row justify-content-between mb-6 mt-6">
  <div class="d-flex flex-fill col-md-4 col-xxl-2 text-center border-translucent border-end-0 border-md-end pb-4 pb-xxl-0">
    <div class="flex-grow-1">
      <span class="uil fs-5 lh-1 fa-solid fa-users-line text-primary"></span>
      <h1 class="fs-5 pt-3">25</h1>
      <p class="fs-9 mb-0">Total Students</p>
    </div>
  </div>
  <div class="d-flex flex-fill col-md-4 col-xxl-2 text-center border-translucent border-start border-end-0 border-md-end pb-4 pb-xxl-0">
    <div class="flex-grow-1">
      <span class="uil fs-5 lh-1 fa-solid fa-check text-success"></span>
      <h1 class="fs-5 pt-3">15</h1>
      <p class="fs-9 mb-0">Total Present</p>
    </div>
  </div>
  <div class="d-flex flex-fill col-md-4 col-xxl-2 text-center border-translucent border-start border-end border-end-md-0 pb-4 pb-xxl-0 pt-4 pt-md-0">
    <div class="flex-grow-1">
      <span class="uil fs-5 lh-1 fa-solid fa-times text-danger"></span>
      <h1 class="fs-5 pt-3">10</h1>
      <p class="fs-9 mb-0">Total Absent</p>
    </div>
  </div>
</div>

<div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-7 pb-3 border-y mb-6">
  <div class="mt-3" id="todayStudentsAttendance" data-list='{"valueNames":["fullname","attendance","status","datetime", "remarks"],"page":10,"pagination":true}'>
    <div class="row align-items-end justify-content-between pb-4 g-3">
      <div class="col-auto">
        <h3>Today Attendances</h3>
        <p class="text-body-tertiary lh-sm mb-0">Today's attendance data is filtered.</p>
      </div>

      <div class="col-12 col-md-auto">
        <div class="search-box">
          <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
            <input class="form-control search-input search form-control-sm" type="search" placeholder="Search attendances" aria-label="Search" />
            <span class="fas fa-search search-box-icon"></span>
          </form>
        </div>
      </div>

    </div>

    <div class="table-responsive ms-n1 ps-1 scrollbar">
      <table class="table fs-9 mb-0 border-top border-translucent">
        <thead>
          <tr>
            <th class="sort white-space-nowrap align-middle ps-0 text-uppercase" scope="col" data-sort="fullname" style="width:15%;min-width: 100px;">Full Name</th>
            <th class="sort align-middle text-uppercase text-center" scope="col" data-sort="attendance" style="width:20%;min-width: 150px; ">Attendance</th>
            <th class="sort align-middle ps-0 text-center text-uppercase" scope="col" data-sort="status" style="width:15%;min-width: 100px;">Status</th>
            <th class="sort align-middle ps-0 text-center text-uppercase" scope="col" data-sort="datetime" style="width:15%;min-width: 100px;">Date Time</th>
            <th class="sort align-middle ps-0 text-center text-uppercase" scope="col" data-sort="remarks" style="width:15%;min-width: 100px;">Remarks</th>
            <th class="sort align-middle text-end" scope="col" style="width: 5%"></th>
          </tr>
        </thead>

        <tbody class="list" id="attendance-table-content">
          <% 
           let filteredTodayAttendances;
           if(attendancesToday && attendancesToday.length > 0){  
              if(user.isTeacher){
                filteredTodayAttendances = attendancesToday.filter(attendance => {
                    return attendance.child.class && attendance.child.class._id.toString() === classTeacher.class.toString(); });
              }else if(user.isPublicUser){
                if(parent){
                    filteredTodayAttendances = attendancesToday.filter(attendance => {
                        return attendance.child.parent && attendance.child.parent.user.toString() === parent.user.toString(); });
                }else{
                    filteredTodayAttendances = '';
                }
              }else{
                filteredTodayAttendances = attendancesToday;
              }
           }else{  
            filteredTodayAttendances = '';  
           } 

        
          %>

          <% if(filteredTodayAttendances && filteredTodayAttendances.length > 0){ %>
          <% filteredTodayAttendances.forEach((item, index) => { %>

          <tr class="position-static">
            <td class="fullname align-middle white-space-nowrap py-4 ps-0 fw-bold fs-9 fs-xxl-8">
              <a class="no-loader" data-bs-toggle="modal" data-bs-target="#studentModal<%= index %>" href="#"><%= item.child.name %></a>
            </td>
            <td class="attendance align-middle fw-semibold text-center py-2 ps-0 fs-9">
              <div class="d-inline-flex">
                <span class="btn btn-outline-success">Present</span>&nbsp;&nbsp;<span class="btn btn-outline-danger">Absent</span>
              </div>
            </td>
            <td class="status align-middle text-center py-2 ps-2 fs-9"><span class="badge badge-phoenix badge-phoenix-primary"><%= item.status %></span></td>
            <td class="datetime align-middle text-center fw-semibold py-2 ps-0 fs-9"><%= item.date ? item.date.toLocaleDateString('en-MY') : '-' %></td>
            <td class="remarks align-middle text-center py-2 ps-0 fs-9 fw-semibold text-body-highlight fst-italic"><%= item.remarks ? item.remarks : 'No remarks yet' %></td>
            <td class="align-middle text-end white-space-nowrap pe-0 action">
              <div class="font-sans-serif btn-reveal-trigger position-static">
                <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs--2" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
                  <span class="fas fa-ellipsis-h fs-9"></span>
                </button>
                <div class="dropdown-menu dropdown-menu-end py-2">
                  <a class="dropdown-item no-loader" data-bs-toggle="modal" data-bs-target="#updateRemark<%= index %>" href="#">Update Remarks</a>
                </div>
              </div>
            </td>
          </tr>

          <!-- Modal to view more student details -->
          <div class="modal fade" id="studentModal<%= index %>" tabindex="-1" aria-labelledby="studentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="studentModalLabel">Student Information</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!-- Information about the student -->
                  <div class="row g-3 mb-3">
                    <div class="col-md-6">
                      <label for="fullname" class="form-label"><b>Student Name</b></label>
                      <p class="form-label text-primary"><%= item.child.name %></p>
                    </div>
                    <div class="col-md-6">
                      <label for="address" class="form-label"><b>Address</b></label>
                      <p class="form-label text-primary"><%= item.child.adress %></p>
                    </div>
                  </div>
                  <div class="row g-3 mb-3">
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label"><b>IC Number</b></label>
                      <p class="form-label text-primary"><%= item.child.nric %></p>
                    </div>
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label"><b>Date of Birth</b></label>
                      <p class="form-label text-primary"><%= item.child.dob.toLocaleDateString('en-MY') %></p>
                    </div>
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label"><b>Place of Birth</b></label>
                      <p class="form-label text-primary"><%= item.child.pob %></p>
                    </div>
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label"><b>Citizenship</b></label>
                      <p class="form-label text-primary"><%= item.child.citizenship %></p>
                    </div>
                    <div class="col-md-6">
                      <label for="paidAmount" class="form-label"><b>Race</b></label>
                      <p class="form-label text-primary"><%= item.child.race %></p>
                    </div>
                  </div>

                  <!-- Information about the student's Parent -->
                  <%
                  let showParent;
                  if(!item.child.parent || item.child.parent === null){
                    showParent = "d-none";
                  }else {
                    showParent = "";
                  }
                  %>
                  <div class="<%= showParent %>">
                    <hr>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="fullname" class="form-label"><b>Parent's Name</b></label>
                        <p class="form-label text-primary">George</p>
                      </div>
                      <div class="col-md-6">
                        <label for="paidAmount" class="form-label"><b>Occupation</b></label>
                        <p class="form-label text-primary">Pilot</p>
                      </div>
                    </div>
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="paidAmount" class="form-label"><b>IC Number</b></label>
                        <p class="form-label text-primary">990101-12-1234</p>
                      </div>
                      <div class="col-md-6">
                        <label for="paidAmount" class="form-label"><b>Phone Number</b></label>
                        <p class="form-label text-primary">0123456789</p>
                      </div>
                    </div>
                  </div>

                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal add/update remarks -->
          <div class="modal fade" id="updateRemark<%= index %>" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form action="" method="post">
                  <div class="modal-body">
                    <label class="form-label" for="udpateDescription">Remarks</label>
                    <textarea class="form-control scrollbar-overlay" placeholder="Leave a attendance remark here" style="height: 100px" name="remarks"></textarea>
                  </div>
                  <div class="modal-footer border-top-0">
                    <button class="btn btn-primary loading-button" type="submit">
                      <div class="content-button">
                        <span>Update</span>
                      </div>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <% }); %>
          <% }else{ %>
          <tr>
            <td colspan="5" class="text-center fw-bold fs-9">No students attendance detected</td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>

    <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
      <div class="col-auto d-flex">
        <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold no-loader" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none no-loader" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
      </div>
      <div class="col-auto d-flex">
        <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
        <ul class="mb-0 pagination"></ul>
        <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
      </div>
    </div>
  </div>
</div>

<script>
  let currentRemarkId = null; // Store the current remark ID for the modal

  // Open modal and capture remark ID
  document.querySelectorAll('.dropdown-item[data-remark-id]').forEach(function(item) {
    item.addEventListener('click', function() {
      currentRemarkId = this.getAttribute('data-remark-id'); // Capture the remark ID for the clicked row
      const remarkText = document.getElementById(currentRemarkId).innerText.trim();
      document.getElementById('remarksInput').value = remarkText !== 'No remarks yet' ? remarkText : ''; // Pre-fill with existing remark if available
    });
  });

  // Handle the Save Remarks button click
  document.getElementById('saveRemarks').addEventListener('click', function() {
    const remarkInput = document.getElementById('remarksInput').value.trim();
    const remarksElement = document.getElementById(currentRemarkId);

    if (remarkInput) {
      // Update the remarks in the table
      remarksElement.innerHTML = `<span class="text-info">${remarkInput}</span>`;
    } else {
      // Default if no remark is provided
      remarksElement.innerHTML = `<em>No remarks yet</em>`;
    }

    // Close the modal after saving
    const modal = bootstrap.Modal.getInstance(document.getElementById('updateRemarksModal'));
    modal.hide();
  });

  // Handle the attendance checkbox
  document.querySelectorAll('.attendance-checkbox').forEach(function(checkbox) {
    checkbox.addEventListener('change', function() {
      const statusId = this.getAttribute('data-status-id');
      const statusElement = document.getElementById(statusId);
      const checkboxes = document.getElementsByName(this.name);

      // Get current time
      const currentTime = new Date().toLocaleTimeString([], {
        hour: '2-digit',
        minute: '2-digit'
      });

      // Uncheck other checkboxes
      checkboxes.forEach(function(box) {
        if (box !== checkbox) {
          box.checked = false;
        }
        // Disable all checkboxes after one is selected
        box.disabled = true;
      });

      // Update status based on the checkbox value and apply styling
      if (this.id.includes('present')) {
        if (this.checked) {
          statusElement.innerHTML = `
                    <span class="badge badge-phoenix badge-phoenix-success fs-10 align-items-center">Present</span>
                    <br>
                    <span class="badge badge-phoenix badge-phoenix-warning fs-10 align-items-center">${currentTime}</span>`;
        } else {
          statusElement.innerHTML = '-';
        }
      } else if (this.id.includes('absent')) {
        if (this.checked) {
          statusElement.innerHTML = `
                    <span class="badge badge-phoenix badge-phoenix-danger fs-10 align-items-center">Absent</span>
                    <br>
                    <span class="badge badge-phoenix badge-phoenix-warning fs-10 align-items-center">${currentTime}</span>`;
        } else {
          statusElement.innerHTML = '-';
        }
      }
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.attendance-checkbox');

    checkboxes.forEach((checkbox) => {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          // Disable both checkboxes (Present and Absent) once one is clicked
          const statusId = this.getAttribute('data-status-id');
          const relatedCheckboxes = document.querySelectorAll(`input[data-status-id="${statusId}"]`);

          // Handle checkbox coloring and disabling
          relatedCheckboxes.forEach(cb => {
            cb.disabled = true; // Disable both checkboxes
            const checkboxLabel = cb.nextElementSibling;
            if (cb.checked && cb.value === "present") {
              checkboxLabel.classList.add('checked-green'); // Show green for present
            } else if (cb.checked && cb.value === "absent") {
              checkboxLabel.classList.add('checked-red'); // Show red for absent
            }
          });
        }
      });
    });
  });

  // Handle the search input
  document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#vis-table tbody tr');
    //let visibleRows = 0;

    rows.forEach(function(row) {
      const name = row.cells[0].textContent.toLowerCase(); // Student Name column
      const status = row.cells[3].textContent.toLowerCase(); // Status column

      if (name.includes(searchTerm) || status.includes(searchTerm)) {
        row.style.display = ''; // Show row if matches
        //visibleRows++;
      } else {
        row.style.display = 'none'; // Hide row if not matching
      }
    });

    // Check if any rows are visible
    // if (visibleRows === 0) {
    //     document.querySelector('#vis-table tbody').innerHTML = 
    //         '<tr><td colspan="12" style="text-align:center;">No search list found</td></tr>';
    // }
  });

  // Enable checkboxes when 'Edit Attendance' is clicked
  // document.querySelectorAll('.edit-attendance-link').forEach(function(editLink) {
  //     editLink.addEventListener('click', function(event) {
  //         event.preventDefault(); 

  //         // Enable the related checkboxes
  //         const studentId = this.getAttribute('data-student-id');
  //         const attendanceCheckboxes = document.querySelectorAll('input[name="attendance' + studentId + '"]');

  //         attendanceCheckboxes.forEach(function(checkbox) {
  //             checkbox.disabled = false; 
  //         });
  //     });
  // });

  // Initialize Datepicker
  // $(document).ready(function () {
  //     const today = new Date();
  //     const day = String(today.getDate()).padStart(2, '0');
  //     const month = String(today.getMonth() + 1).padStart(2, '0');
  //     const year = today.getFullYear();
  //     const currentDate = `${day}-${month}-${year}`;

  //     flatpickr("#inputStartDate", {
  //         defaultDate: currentDate,
  //         dateFormat: "d-m-Y", 
  //         disableMobile: true 
  //     });
  // });
</script>

<%- include('partials/private-footer.ejs') %>