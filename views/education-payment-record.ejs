<%- include('partials/private-header.ejs') %>

<nav class="mb-2" aria-label="breadcrumb">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="#!">Payment</a></li>
    <li class="breadcrumb-item"><a href="#!">Fees</a></li>
    <li class="breadcrumb-item"><a href="#!">Details</a></li>
    <li class="breadcrumb-item active" aria-current="page"><%= payment._id %></li>
  </ol>
</nav>

<div class="row d-flex flex-wrap justify-content-between align-items-end mb-2">

  <div class="col-auto mb-2">
    <h2>Payment <%= new Date(payment.date.payment).toLocaleString('en-MY', { year: 'numeric', month: 'long' }) %> <a class="notranslate" href="#">#<%= payment.child.name %></a></h2>
    <p class="text-body-secondary mb-0">Payment must be made before <br class="d-sm-none"><span class="ms-sm-1"><%= payment.date.payment ? new Date(payment.date.payment ).toLocaleString('en-MY', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true }) : '-' %></span></p>
  </div>

  <div class="col-auto d-flex justify-content-center mb-3 mb-xl-0">
    <div>
      <button class="btn btn-success me-2" type="button" id="pay-button">Pay</button>
    </div>
    <div>
      <a class="btn btn-outline-primary me-2" role="button" href="">Approve</a>
      <a class="btn btn-outline-danger me-2" role="button" href="">Deny</a>
    </div>
    <div>
      <button class="btn px-3 btn-phoenix-secondary" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fa-solid fa-ellipsis"></span></button>
      <ul class="dropdown-menu dropdown-menu-end p-0" style="z-index: 9999;">
        <li><a class="dropdown-item" href="">Download Invoice</a></li>
        <li><a class="dropdown-item no-loader" href="#!" data-bs-target="#add-comment" data-bs-toggle="modal">Add Remarks</a></li>
        <li><a class="dropdown-item no-loader" href="#!">Print</a></li>
      </ul>
    </div>
  </div>

</div>

<div class="row gy-5 gx-5 mb-xxl-6 mb-6">

  <div class="col-12 col-xl-6 order-1 order-xl-0">
    <div class="card mt-n5 mt-xl-0">
      <div class="card-body overflow-auto overflow-x-hidden scrollbar vh-50">
        <div class="p-3 pt-1">

          <div class="row g-3 d-flex justify-content-between mb-0 px-1 py-2">

            <div class="col-auto d-flex align-items-center">
              <p class="text-end fw-bold fs-7 fst-italic">RM <span id="total-fees"><%= payment.totalAmount.toFixed(2) %></span></p>
            </div>

            <div class="col-auto">
              <lottie-player class="me-n4" src="https://lottie.host/2f792096-09e2-4afa-951f-03c7bb0c19db/ZWID7JG5YG.json" background="transparent" speed="1" style="width: 75px; height: 75px;" loop autoplay></lottie-player>
            </div>
          </div>

          <div class="mb-3">
            <div class="slick-slider">
              <% payment.products.forEach(product => { %>
              <div class="card mx-2" data-unique-id="<%= product._id %>">
                <div class="card-body d-flex justify-content-center">
                  <p class="card-text mx-auto"><%= product.name %> - RM <%= product.price %></p>
                </div>
                <div class="card-footer d-flex justify-content-center">
                  <button class="btn btn-danger delete-slide-btn mx-auto" data-id="<%= product._id %>">Delete</button>
                  <p class="mx-2 d-none" data-fees="<%= product.price %>">RM <%= product.price %></p>
                  <p class="mx-2 d-none" data-product="<%= product.name %>"><%= product.name %></p>
                </div>
              </div>
              <% }) %>
            </div>
          </div>

          <div class="mb-3">
            <div class="border p-3 rounded-3 overflow-y-auto overflow-x-hidden scrollbar" id="fees" style="height: 17.5vh;">
              <ul class="list-group list-group-flush" id="fees-list">
                <% payment.products.forEach(product => { %>
                <li class="list-group-item border-top-0 border-bottom border-start-0 border-end-0 border-2" data-id="<%= product._id %>"><%= product.name %>: RM <%= product.price %></li>
                <% }) %>
              </ul>
            </div>
          </div>

          <div class="mb-6 d-none">
            <h5 class="mb-2">Remarks</h5>
            <div class="border p-3 rounded-3">
              <p class="text-body-highlight"><%= payment.remarks %></p>
            </div>
          </div>

          <%
                  const formatDateFile = (date) => {
                    const options = { day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric', hour12: true };
                    const formattedDate = new Intl.DateTimeFormat('en-US', options).format(date);
                
                    // Add day suffix (st, nd, rd, or th)
                    const day = date.getDate();
                    const daySuffix = (day) => {
                      if (day >= 11 && day <= 13) {
                        return 'th';
                      }
                      const lastDigit = day % 10;
                         switch (lastDigit) {
                      case 1: return 'st';
                      case 2: return 'nd';
                      case 3: return 'rd';
                      default: return 'th';
                    }
                    };
                
                    return formattedDate.replace(/(\d+)/, (match, p1) => `${p1}${daySuffix(day)}`);
                  };
                %>

          <div class="mb-6">
            <div class="card mb-3">
              <div class="card-body">
                <% const modalFiles = files.filter((file) => file.uuid === payment.fileId); %>
                <% const lastIndexFile = modalFiles.length - 1; var borderModalFile = ''; %>
                <% if(modalFiles && modalFiles.length > 0){ %>
                <% modalFiles.forEach((file, index) => { %>

                <% 
                  if(index === lastIndexFile){
                      borderModalFile = 'border-bottom';
                  } else {
                      borderModalFile = '';
                  }
              %>

                <% if(file.type === '.png' || file.type === '.webp' || file.type === '.jpg' || file.type === '.jpeg' || file.type === '.gif' ){ %>
                <div class="px-0 pt-0 pb-3">
                  <div class="me-n3">
                    <div class="d-flex flex-between-center">
                      <div class="d-flex mb-1"><span class="fa-solid fa-image me-2 text-body-tertiary fs-9"></span>
                        <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                      </div>
                      <div class="btn-reveal-trigger">
                        <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                        <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item text-danger" href="/files/delete/<%= file._id %>">Delete</a><a class="dropdown-item" href="/files/download/<%= file._id %>">Download</a><a class="dropdown-item d-none" href="#!">Report abuse</a></div>
                      </div>
                    </div>
                    <div class="d-flex fs-9 text-body-tertiary mb-2 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="/staff/details/<%= file.user %>"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div><img class="rounded-2" src="<%= file.path %>" alt="" style="max-width:230px" />
                  </div>
                </div>

                <% }else { %>

                <div class="px-0 pt-4 pb-3">
                  <div class="me-n3">
                    <div class="d-flex flex-between-center">
                      <div>
                        <div class="d-flex align-items-center mb-1"><span class="fa-solid fa-image me-2 fs-9 text-body-tertiary"></span>
                          <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                        </div>
                        <div class="d-flex fs-9 text-body-tertiary mb-0 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="/staff/details/<%= file.user %>"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div>
                      </div>
                      <div class="btn-reveal-trigger">
                        <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                        <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item d-none" href="#!">Edit</a><a class="dropdown-item text-danger" href="/files/delete/<%= file._id %>">Delete</a><a class="dropdown-item" href="/files/download/<%= file._id %>">Download</a><a class="dropdown-item d-none" href="#!">Report abuse</a></div>
                      </div>
                    </div>
                  </div>
                </div>

                <% } %>
                <% }); %>
                <% }else { %>
                <p class="fs-9">There is no file attached</p>
                <% } %>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6 order-0 order-xl-1">
    <div class="p-1">
      <div class="row g-2">
        <div class="col-10 ms-n2">
          <label for="productSelect" class="form-label">Select Product</label>
          <select class="form-select mx-2" id="add-slide-select">
            <option value="">Select an option</option>
            <% products.forEach(product => { %>
            <option value="<%= product.name %> - RM <%= product.price %>" data-sku="<%= product.sku %>" data-price="<%= product.price %>" data-product="<%= product.name %>" class="<%= product.quantity === 0 ? 'd-none' : '' %>">
              <%= product.name %> - RM <%= product.price %>
            </option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3 col-2">
          <button class="btn btn-primary mt-4 mx-2" id="add-slide-btn">+</button>
        </div>
      </div>
      <div class="mb-3 d-none">
        <label for="remark" class="form-label">Remark</label>
        <textarea class="form-control" id="remark" name="remark" rows="3"></textarea>
      </div>
    </div>

    <script>
      $(document).ready(function() {
        var slideIds = JSON.parse('<%- productIds %>');;
        console.log(slideIds);

        $('.slick-slider').slick({
          arrows: false,
          dots: true,
          infinite: true,
          speed: 300,
          slidesToShow: 3,
          slidesToScroll: 3,
          responsive: [{
              breakpoint: 1024,
              settings: {
                slidesToShow: 1,
                slidesToScroll: 1,
                infinite: true,
                dots: true
              }
            },
            {
              breakpoint: 600,
              settings: {
                slidesToShow: 1,
                slidesToScroll: 1
              }
            },
            {
              breakpoint: 480,
              settings: {
                slidesToShow: 1,
                slidesToScroll: 1
              }
            }
          ]
        });

        function generateUniqueId() {
          return 'slide-' + new Date().getTime() + '-' + Math.random().toString(36).substr(2, 9);
        }

        $('#add-slide-btn').click(function() {
          var selectedOption = $('#add-slide-select').find('option:selected');
          var text = selectedOption.val();
          var fees = parseFloat(selectedOption.data('price'));
          var product = selectedOption.data('product');
          var sku = selectedOption.data('sku');
          var uniqueId = generateUniqueId(); // Generate unique ID for the slide

          if (text !== '') {
            console.log('add slide with unique ID: ' + uniqueId);
            $('.slick-slider').slick('slickAdd', `
             <div class="card mx-2" data-unique-id="${uniqueId}">
               <div class="card-body d-flex justify-content-center">
                 <p class="card-text mx-auto">${text}</p>
               </div>
               <div class="card-footer d-flex justify-content-center">
                 <button class="btn btn-danger delete-slide-btn mx-auto" data-id="${uniqueId}">Delete</button>
                 <p class="mx-2 d-none" data-fees="${fees}">RM ${fees}</p>
                 <p class="mx-2 d-none" data-product="${product}">${product}</p>
                 <p class="mx-2 d-none" data-sku="${sku}">${sku}</p>
               </div>
             </div>
           `);
            var totalFees = parseFloat($('#total-fees').text()) + fees;
            $('#total-fees').text(totalFees.toFixed(2));
            $('#fees-list').append(`<li class="list-group-item border-top-0 border-bottom border-start-0 border-end-0 border-2" data-id="${uniqueId}">${product}: RM ${fees}</li>`);

            // Add the unique ID to the array
            slideIds.push(uniqueId);
          }
        });

        $('.slick-slider').on('click', '.delete-slide-btn', function(event) {
          var uniqueId = $(this).data('id');
          var fees = parseFloat($(this).siblings('p[data-fees]').attr('data-fees'));
          var product = $(this).siblings('p[data-product]').attr('data-product');
          console.log('delete slide with unique ID: ' + uniqueId);

          try {
            // Find the index of the slide in the array
            var slideIndex = slideIds.indexOf(uniqueId);
            if (slideIndex !== -1) {
              // Remove the slide from the Slick slider
              $('.slick-slider').slick('slickRemove', slideIndex);

              // Remove the slide ID from the array
              slideIds.splice(slideIndex, 1);
            } else {
              console.error('Slide not found with unique ID:', uniqueId);
            }
          } catch (error) {
            console.error('Error removing slide:', error);
          }

          var totalFees = parseFloat($('#total-fees').text()) - fees;
          $('#total-fees').text(totalFees.toFixed(2));

          $('#fees-list li[data-id="' + uniqueId + '"]').remove();
        });

        $('#pay-button').click(function() {
          const totalFees = parseFloat($('#total-fees').text());
          const paymentId = '<%= payment._id %>';
          const productDetails = [];

          // Iterate over dynamically added products to collect SKUs and other details
          $('.slick-slider .card').each(function() {
            const productSKU = $(this).find('p[data-sku]').data('sku');
            const productName = $(this).find('p[data-product]').data('product');
            const productPrice = $(this).find('p[data-fees]').data('fees');
            if (productSKU && productName && productPrice) {
              productDetails.push({
                sku: productSKU,
                name: productName,
                price: productPrice
              });
            }
          });

          $.post('/education/payment/record/pay', {
              totalFees: totalFees,
              paymentId: paymentId,
              products: productDetails
            })
            .done(function(response) {
              alert('Payment succesful.');
              setTimeout(function(){
                location.reload();
              }, 1000);
            })
            .fail(function(error) {
              alert('Payment failed.');
              console.error('Payment error:', error);
            });
        });
      });
    </script>

  </div>

</div>

<%- include('partials/private-footer.ejs') %>