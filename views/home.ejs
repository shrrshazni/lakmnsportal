<%- include('partials/private-header.ejs') %>

<script>
  // take the root of the colour from css for echarts
  const style = getComputedStyle(document.body);
  const theme = {
    primary: style.getPropertyValue('--phoenix-primary'),
    secondary: style.getPropertyValue('--phoenix-secondary'),
    success: style.getPropertyValue('--phoenix-success'),
    info: style.getPropertyValue('--phoenix-info'),
    warning: style.getPropertyValue('--phoenix-warning'),
    danger: style.getPropertyValue('--phoenix-danger'),
    bg_primary_subtle: style.getPropertyValue('--phoenix-primary-bg-subtle'),
    tertiary: style.getPropertyPriority('--phoenix-tertiary-color'),
    light: style.getPropertyValue('--phoenix-light'),
    dark: style.getPropertyValue('--phoenix-dark'),
    secondary_subtle: style.getPropertyValue('--phoenix-secondary-border-subtle'),
    cyan: style.getPropertyValue('--phoenix-cyan'),
    gray_100: style.getPropertyValue('--phoenix-gray-100')

  };

  //   take css class color based on their property color/bg-colour for echarts
  function getColor(className, property) {
    var element = document.createElement('div');
    element.className = className;
    document.body.appendChild(element);

    var computedStyle = window.getComputedStyle(element);
    var color = computedStyle.getPropertyValue(property);

    document.body.removeChild(element);

    return color;
  }
</script>

<!-- user -->
<div class="mb-3">
  <div class="card px-2 py-1" id="closableCard">
    <div class="card-header d-flex justify-content-between border-bottom-0">
      <h3 class="mb-0">Announcements</h3>
      <button type="button" class="btn-close" aria-label="Close" onclick="closeCard()"></button>
    </div>

    <hr class="mt-n1">

    <style>
      #typing-container {
        overflow: hidden;
        position: relative;
      }

      .card-text {
        display: inline-block;
      }

      #cursor {
        display: inline-block;
        margin-left: 3px;
        /* Adjust the cursor position */
      }

      .blink {
        animation: blink-animation 1s steps(1, start) infinite;
      }

      @keyframes blink-animation {
        to {
          visibility: hidden;
        }
      }
    </style>

    <div class="card-body text-center" id="typing-container">
      <p class="card-text fs-7 fw-semibold" id="typing-text"></p><span id="cursor" class="fs-7">|</span>
    </div>
  </div>

  <script>
    function closeCard() {
      const closableCard = document.getElementById('closableCard');
      closableCard.style.display = 'none';
    }

    document.addEventListener("DOMContentLoaded", function() {
      const textElement = document.getElementById("typing-text");
      const cursorElement = document.getElementById("cursor");
      const text = "Upcoming lakmnsportal app launches are imminent, with anticipated releases scheduled in the near future, bringing exciting new features and experiences.";

      let charIndex = 0;

      function type() {
        if (charIndex <= text.length) {
          textElement.innerHTML = text.substring(0, charIndex);
          charIndex++;
          setTimeout(type, 60); // Adjust the typing speed here
        }
      }

      function blinkCursor() {
        cursorElement.classList.toggle("blink");
        setTimeout(blinkCursor, 500); // Adjust the blinking speed here
      }

      type();
      blinkCursor();
    });
  </script>
</div>

<div class="row gy-3 mb-3 justify-content-between d-flex mt-0">
  <div class="col-md-9 col-auto">
    <h2 class="mb-2 text-body-emphasis">Dashboard</h2>
    <h5 class="text-body-tertiary fw-semibold">Real-time data visualization for informed decision-making</h5>
  </div>
  <div class="col-md-3 col-auto row g-3 ms-2">
    <div class=" col-12 btn btn-phoenix-secondary my-auto">Announcements</div>
  </div>
</div>

<div class="row gy-6 mb-6">
  <div class="col-12 col-xxl-8 row mb-3 gy-3">
    <div class="d-flex flex-column justify-content-between pb-3">
      <div class="row g-5 my-auto">
        <div class="row align-items-center g-3 gx-0 mb-0 text-center text-md-start col-12 col-md-6 ms-2 ms-xxl-0">
          <div class="col-12 col-md-6 mb-sm-3 ps-lg-7">
            <div class="avatar avatar-5xl"><img class="rounded-circle border border-primary" src="/assets/img/team/avatar.webp" alt="" /></div>
          </div>

          <% 
            if(user.section === ''){
                var showSection = ''
            }else{
                var showSection =  user.section;
            }
          %>
          <div class="col-12 col-md-6 flex-1">
            <h3 class="mx-auto white-space-nowrap"><%= user.fullname %></h3>
            <p class="fw-bold"><%= user.position %><br><span class="fw-normal fst-italic"> <%= user.department %><br><%= showSection %></span></p>
            <p class="mx-auto text-primary fst-italic">"<%= info.status %>"</p>
          </div>
        </div>

        <div class="col-md-6">

        </div>
      </div>
      <div class="d-flex flex-between-center border-top border-dashed pt-4">
        <%
            const totalTasks = tasks.filter(task => {
              return task.assignee && Array.isArray(task.assignee) &&
                     task.assignee.some(assignee => assignee._id && assignee._id.toString() === user._id.toString());
            });

            const doneTasks1 = totalTasks.filter(task => task.status === 'done').length; 
            const processTasks1 = totalTasks.filter(task => task.status === 'process').length; 

            const totalActivity = otherActivities.filter(item => {
             return item.user.toString() === user._id.toString();
            });
        %>
        <div>
          <h6>Tasks</h6>
          <p class="fs-7 text-body-secondary mb-0"><%= totalTasks.length %></p>
        </div>
        <div>
          <h6>Activities</h6>
          <p class="fs-7 text-body-secondary mb-0"><%= totalActivity.length %></p>
        </div>
        <div>
          <h6>Completion</h6>
          <p class="fs-7 text-body-secondary mb-0"><%= doneTasks1 %></p>
        </div>
        <div>
          <h6>In Process</h6>
          <p class="fs-7 text-body-secondary mb-0"><%= processTasks1 %></p>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-xxl-4">
    <div class="carousel dashboard-carousel slide carousel-fade position-relative rounded-3" id="carousel-1">
      <div class="carousel-inner">

        <div class="carousel-item active" style="height: 375px;">

          <div class="card overflow-y-auto scrollbar" style="height: 375px;">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div class="badge badge-phoenix fs-10 badge-phoenix-primary mb-4"><span class="fa-solid fa-bell me-2"></span><span class="fw-bold">Notifications</span></div>
                <a class="btn btn-link p-0 fs-9 fw-normal" role="button" href="/markAllAsRead">Mark all as read</a>
              </div>


              <% 
              function timeAgo(timestamp) {
                 const now = new Date();
                 const notificationDate = new Date(timestamp);
                 const secondsAgo = Math.floor((now - notificationDate) / 1000);
    
                 const intervals = [
                 { label: 'y', seconds: 31536000 },
                  { label: 'mon', seconds: 2592000 },
                  { label: 'd', seconds: 86400 },
                 { label: 'h', seconds: 3600 },
                  { label: 'm', seconds: 60 },
                  { label: 's', seconds: 1 }
                 ];
    
                 for (const interval of intervals) {
                 const intervalValue = Math.floor(secondsAgo / interval.seconds);
    
                 if (intervalValue >= 1) {
                     return intervalValue + (intervalValue === 1 ? interval.label : interval.label);
                 }
                }

              return 'Just now';
              }

              function formatTime(timestamp) {
                  const options = { year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true, timeZone:'Asia/Kuala_Lumpur' };
                  const formattedTime = new Date(timestamp).toLocaleString(undefined, options);
                  return formattedTime;
              }
              %>


              <div class="">
                <% if (notifications.length > 0) { %>
                <% notifications.forEach(notification => { %>
                <div class="px-1 px-sm-3 py-3 notification-card position-relative read border-bottom">
                  <div class="d-flex align-items-center justify-content-between position-relative">
                    <div class="d-flex">
                      <div class="avatar avatar-m status-online me-3">

                        <%
                          var notiProfile = '';
                          if(notification.sender.profile === ''){
                            notiProfile = '/assets/img/team/avatar.webp';
                          }else{
                            notiProfile = notification.sender.profile;
                          } 
                          %>
                        <!-- Use the actual image source from your notification -->
                        <img class="rounded-circle border border-primary" src="<%= notiProfile %>" alt="" />
                      </div>
                      <div class="flex-1 me-sm-3">
                        <h4 class="fs-9 text-body-emphasis"><%= notification.sender.fullname %></h4>
                        <p class="fs-9 text-body-highlight mb-2 mb-sm-3 fw-normal">
                          <span class='me-1 mt-1 fs-10'>ðŸ’¬</span><%= notification.message %>
                          <span class="text-body-quaternary text-opacity-75 fw-bold fs-10">&nbsp;<%= timeAgo(notification.timestamp) %></span>
                        </p>
                        <p class="text-body-secondary fs-9 mb-0">
                          <span class="me-1 fas fa-clock"></span>
                          <span class="fw-bold"><%= formatTime(notification.timestamp) %></span>
                        </p>
                      </div>
                    </div>
                    <div class="btn-group dropstart mb-3">
                      <button class="btn fs-10 btn-sm dropdown-toggle dropdown-caret-none transition-none notification-dropdown-toggle" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
                        <span class="fas fa-ellipsis-h fs-10 text-body"></span>
                      </button>
                      <div class="dropdown-menu py-2">
                        <a class="dropdown-item" href="/markAsRead/<%= notification._id %>">Mark as unread</a>
                        <a class="dropdown-item" href="<%= notification.url %>">View</a>
                      </div>
                    </div>
                  </div>
                </div>

                <% }); %>
                <% } else { %>
                <div class="px-2 px-sm-3 py-3">
                  <p>No notifications available.</p>
                </div>
                <% } %>
              </div>
            </div>
            <div class="p-0 border-top border-translucent border-0 w-100">
              <div class="my-2 text-center fw-bold fs-10 text-body-tertiary text-opactity-85"><a class="fw-bolder" href="/">Notification history</a></div>
            </div>
          </div>

        </div>

        <div class="carousel-item false">

          <div class="card" style="height: 375px;">
            <div class="card-body">

              <h5 class="text-body-emphasis text-nowrap">Leave Balances</h5>
              <div class="mx-auto mt-n7" id="leave-type-chart-carousel" style="height:400px; width: 250px;"></div>

              <script>
                const leaveTypeURL = '/api/echarts/leaveType/<%= user._id %>';

                fetch(leaveTypeURL)
                  .then(response => response.json())
                  .then(fetchLeaveTypeData1 => {
                    updateLeaveTypeChart(fetchLeaveTypeData1, 'leave-type-chart-carousel');
                  })
                  .catch(error => {
                    console.error('Error fetching user leave data:', error);
                  });
              </script>
            </div>
          </div>

        </div>

        <div class="carousel-item false d-none">
          <div class="card" style="height: 375px;">

            <div class="card-body">
              <p>Hello world 2</p>
            </div>

          </div>
        </div>

      </div>
      <div class="carousel-indicators">
        <button class="active" type="button" data-bs-target="#carousel-1" data-bs-slide-to="0" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#carousel-1" data-bs-slide-to="1" aria-label="Slide 2"></button>
        <button class="d-none" type="button" data-bs-target="#carousel-1" data-bs-slide-to="2" aria-label="Slide 3"></button>
      </div>
    </div>
  </div>
</div>

<div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-7 pb-3 border-y mb-6">
  <div id="team-members" data-list='{"valueNames":["member","position","activity","when","taskprogress","status","action"],"page":6,"pagination":true}'>
    <div class="row align-items-end justify-content-between pb-4 g-3">

      <div class="col-auto">
        <h3>Team Members</h3>
        <p class="text-body-tertiary lh-sm mb-0">Current team member work status and progress</p>
      </div>

      <div class="col-12 col-md-auto">
        <div class="search-box">
          <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
            <input class="form-control search-input search form-control-sm" type="search" placeholder="Search team members" aria-label="Search" />
            <span class="fas fa-search search-box-icon"></span>
          </form>
        </div>
      </div>

    </div>
    <div class="table-responsive ms-n1 ps-1 scrollbar">
      <table class="table fs-9 mb-0 border-top border-translucent">
        <thead>
          <tr>
            <th class="sort white-space-nowrap align-middle ps-0" scope="col" data-sort="member" style="width:15%;">MEMBERS</th>
            <th class="sort align-middle ps-3" scope="col" data-sort="position" style="width:10%;">POSITION</th>
            <th class="sort align-middle ps-3" scope="col" data-sort="activity" style="width:25%;">LATEST ACTIVITY</th>
            <th class="sort align-middle text-center" scope="col" data-sort="when" style="width:15%;">LAST SEEN</th>
            <th class="sort align-middle text-center" scope="col" data-sort="taskprogress" style="width:10%;">PROGRESS</th>
            <th class="sort align-middle text-center" scope="col" data-sort="status" style="width:10%;">STATUS</th>
            <th class="sort align-middle text-end" scope="col" style="width:5%;"></th>
          </tr>
        </thead>
        <tbody class="list" id="project-summary-table-body">
          <% if(userTeamMembers && userTeamMembers.length>0){ %>
          <% userTeamMembers.forEach(department => { %>

          <tr class="position-static">
            <td class="align-middle text-body white-space-nowrap ps-0 member">

              <%
              const checkOnline = allInfo.find(item => item.user.toString() === department._id.toString());

              var showOnline = '';
              if(checkOnline.isOnline === true){
                showOnline = '';
              }else{
                showOnline = 'd-none';
              }
              %>
              <div class="avatar avatar-xl">
                <div class="avatar-name rounded-circle"><span><%= department && department.fullname ? department.fullname[0].toUpperCase() : '' %></span><span class="fa-solid fa-circle ms-n1 position-absolute bottom-0 ps-3 <%= showOnline %>" style="font-size: 8.5px;color: #32b115;"></span></div>
              </div>
              <a class="mb-0 ms-3 fw-bold fs-8" href="/staff/details/<%= department._id %>"><%= department.fullname %></a>
            </td>
            <td class="align-middle white-space-nowrap position ps-3">
              <p class="mb-0 fs-9 text-body-highlight fw-semibold"><%= department.position %></p>
            </td>


            <% const userActivities = otherActivities.filter(activity => activity.user.toString() === department._id.toString()); %>

            <% if (userActivities && userActivities.length > 0) { %>
            <% const latestActivity = userActivities.reduce((latest, activity) => activity.date > latest.date ? activity : latest, userActivities[0]); %>
            <td class="align-middle activity ps-3">
              <p class="fs-9 fw-semibold text-body-highlight mb-0 fst-italic">
                <%= latestActivity.description %>
              </p>
            </td>

            <% } else { %>
            <td class="align-middle white-space-nowrap ps-3 text-start taskprogress">
              <p class="text-body fw-semibold fs-9 mb-0">No activities</p>
            </td>
            <% } %>

            <td class="align-middle white-space-nowrap text-center when ps-0">
              <p class="fw-semibold text-body-secondary fs-9 mb-0">
                <%= checkOnline.lastSeen.toLocaleDateString('en-US', {  
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    hour12: true, 
                    timeZone : 'Asia/Kuala_Lumpur' }) 
                %>
              </p>
            </td>

            <%
            const userTasks = otherTasks.filter(task => {
              return task.assignee && Array.isArray(task.assignee) &&
                     task.assignee.some(assignee => assignee._id && assignee._id.toString() === department._id.toString());
            });
            %>


            <% if (userTasks && userTasks.length > 0) { %>
            <% const doneTasks = userTasks.filter(task => task.status === 'done').length; %>
            <% const cancelledTasks = userTasks.filter(task => task.status === 'cancelled').length; %>
            <% const urgentTasks = userTasks.filter(task => task.status === 'urgent').length; %>
            <% const processTasks = userTasks.filter(task => task.status === 'process').length; %>

            <% const totalTasks = userTasks.length - cancelledTasks; %>
            <% const completionPercentage1 = (doneTasks / totalTasks) * 100; %>
            <% const completionPercentage2 = (cancelledTasks / totalTasks) * 100; %>
            <% const completionPercentage3 = (urgentTasks / totalTasks) * 100; %>
            <% const completionPercentage4 = (processTasks / totalTasks) * 100; %>

            <td class="align-middle white-space-nowrap text-center ps-0 taskprogress">
              <p class="text-body-secondary fs-10 mb-0"><%= `${doneTasks} / ${totalTasks}` %></p>
              <div class="progress" style="height:3px;">
                <div <% /* eslint-disable css-propertyvalueexpected */ %> class="progress-bar bg-success" style="width: <%= completionPercentage1 %>%" aria-valuenow="<%= completionPercentage1 %>" aria-valuemin="0" aria-valuemax="100" role="progressbar"></div>
              </div>
            </td>

            <td class="align-middle white-space-nowrap text-center ps-0 status">
              <div class="progress progress-stack mt-3" style="height:3px;">
                <div <% /* eslint-disable css-propertyvalueexpected */ %> class="progress-bar bg-info" style="width:<%= completionPercentage4 %>%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" role="progressbar"></div>
                <div <% /* eslint-disable css-propertyvalueexpected */ %> class="progress-bar bg-success" style="width:<%= completionPercentage1 %>%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-bs-placement="top" title="5% Damage" role="progressbar"></div>
                <div <% /* eslint-disable css-propertyvalueexpected */ %> class="progress-bar bg-warning" style="width:<%= completionPercentage3 %>%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-bs-placement="top" title="45% Damage" role="progressbar"></div>
                <div <% /* eslint-disable css-propertyvalueexpected */ %> class="progress-bar bg-danger" style="width:<%= completionPercentage2 %>%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100" data-bs-toggle="tooltip" data-bs-placement="top" title="15% Damage" role="progressbar"></div>
              </div>
            </td>
            <% } else { %>
            <td class="align-middle white-space-nowrap ps-0 text-center taskprogress">
              <p class="text-body fw-semibold fs-9 mb-0">No tasks</p>
            </td>

            <td class="align-middle white-space-nowrap ps-0 text-center status">
              <p class="text-body fw-semibold fs-9 mb-0">No tasks</p>
            </td>
            <% } %>

            <td class="align-middle text-end white-space-nowrap pe-0 action">
              <div class="btn-reveal-trigger position-static">
                <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs-10" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h fs-10"></span></button>
                <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item" href="/staff/details/<%= department._id %>">View</a><a class="dropdown-item d-none" href="#!">Export</a>
                  <div class="dropdown-divider d-none"></div><a class="dropdown-item text-danger d-none" href="#!">Remove</a>
                </div>
              </div>
            </td>
          </tr>
          <% }); %>
          <% }else { %>
          <tr class="position-static">
            <td class="mb-0 fs-9 text-body">
              <p>There is no user found in your department</p>
            </td>
          </tr>
          <% } %>
        </tbody>
      </table>
    </div>
    <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
      <div class="col-auto d-flex">
        <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
      </div>
      <div class="col-auto d-flex">
        <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
        <ul class="mb-0 pagination"></ul>
        <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
      </div>
    </div>
  </div>
</div>

<div class="mt-3 mx-lg-n4 mb-6">
  <div class="row g-3">
    <div class="col-12 col-xl-6 col-xxl-7 mb-3">
      <div class="card task-list h-100">
        <div class="card-header border-bottom-0 pb-0">
          <div class="row justify-content-between align-items-center mb-4">
            <div class="col-auto">
              <h3 class="text-body-emphasis">Tasks</h3>
              <p class="mb-0 text-body-tertiary">Monitor team task progress regularly</p>
            </div>
            <div class="col-auto w-100 w-md-auto">
              <div class="row align-items-center g-0 justify-content-between">
                <div class="col-12 col-sm-auto">
                  <div class="search-box w-100 mb-2 mb-sm-0" style="max-width:30rem;">
                    <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                      <input class="form-control search-input search" id="searchInput" type="search" placeholder="Search tasks" aria-label="Search" />
                      <span class="fas fa-search search-box-icon"></span>

                    </form>
                  </div>
                </div>
                <div class="col-auto d-flex">
                  <p class="mb-0 ms-sm-3 fs-9 text-body-tertiary fw-bold"><span class="fas fa-filter me-1 fw-extra-bold fs-10"></span><%= tasks.length %> tasks</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body py-0 scrollbar task-list-body" id="itemList">
          <% if(tasks && tasks.length > 0 ) {%>
          <% const lastIndexItem = tasks.length - 1; %>
          <% tasks.forEach((item,index) => { %>

          <% 
                var todoborder = '';
                var fileAmount = '';
                var displayTaskFile = '';
                var displayTaskSubtask = '';
                var statusTaskColour = '';
                var checked = '';

                const associatedFile = files.filter((file) => file.uuid === item.fileId);
        
                // check last item inside task
                if(index === lastIndexItem){
                    todoborder = 'border-bottom';
                }else{
                    todoborder = '';
                }
        
                // find assc files
                if (associatedFile.length > 0) {
                    fileAmount = associatedFile.length;
                    displayTaskFile = 'd-block';
                } else {
                    fileAmount  = '';
                    displayTaskFile = 'd-none';
                }
        
                // check subtask
                if(item.subtask.length > 0){
                    displayTaskSubtask = 'd-block';
                } else {
                    displayTaskSubtask = '';
                }
        
                // check task status 
                // check task status 
                if(item.status === 'urgent'){
                          statusTaskColour = 'warning';
                          checked = '';
                      } else if(item.status === 'process'){
                          statusTaskColour = 'primary';
                          checked = '';
                      } else if(item.status === 'cancelled'){
                          statusTaskColour = 'danger'; 
                          checked = 'checked';           
                      } else if(item.status === 'done'){
                          statusTaskColour = 'success';
                          checked = 'checked';            
                      }
        
                const showForUser = item.owner.toString() === user._id.toString() ? '' : 'd-none';
              %>

          <div class="item">
            <div class="d-flex hover-actions-trigger py-3 border-top <%= todoborder %>">
              <input class="form-check-input form-check-input-todolist flex-shrink-0 my-1 me-2 form-check-input-undefined" type="checkbox" id="checkbox-todo-2" data-event-propagation-prevent="data-event-propagation-prevent" <%= checked %> />
              <div class="row justify-content-between align-items-md-center btn-reveal-trigger border-translucent gx-0 flex-1 cursor-pointer" data-bs-toggle="modal" data-bs-target="#task<%= index %>">
                <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
                  <div class="mb-1 mb-md-0 d-flex align-items-center lh-1">
                    <label class="form-check-label mb-1 mb-md-0 mb-xl-1 mb-xxl-0 fs-8 me-2 line-clamp-1 text-body cursor-pointer itemName"><%= item.name %></label><span class="badge badge-phoenix ms-auto fs-10 badge-phoenix-<%= statusTaskColour %> itemStatus"><%= item.status %></span>
                  </div>
                </div>
                <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
                  <div class="d-flex lh-1 align-items-center"><a class="text-body-tertiary fw-bold fs-10 me-2 <%= displayTaskFile %>" href="#!"><span class="fas fa-paperclip me-1"></span><%= fileAmount %></a><a class="text-warning fw-bold fs-10 me-2 <%= displayTaskSubtask %>" href="#!"><span class="fas fa-tasks me-1"></span><%= item.subtask.length %></a>
                    <p class="text-body-tertiary fs-10 mb-md-0 me-2 me-md-3 me-xl-2 me-xxl-3 mb-0 itemDate"><%= item.due ? item.due.toLocaleDateString('en-UK', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Not specified' %></p>
                    <div class="hover-md-hide hover-xl-show hover-xxl-hide">
                      <p class="text-body-tertiary fs-10 fw-bold mb-md-0 mb-0 ps-md-3 ps-xl-0 ps-xxl-3 border-start-md border-xl-0 border-start-xxl itemTime"><%= item.reminder ? item.reminder.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true, timeZone: 'Asia/Kuala_Lumpur' }) : 'Not specified' %></p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-none d-md-block d-xl-none d-xxl-block end-0 position-absolute" style="top: 23%;" data-event-propagation-prevent="data-event-propagation-prevent">
                <div class="hover-actions end-0" data-event-propagation-prevent="data-event-propagation-prevent">
                  <button class="btn btn-phoenix-secondary btn-icon me-1 fs-10 text-body px-0 me-1" data-event-propagation-prevent="data-event-propagation-prevent" data-bs-toggle="modal" data-bs-target="#task<%= index %>"><span class="fas fa-edit"></span></button>
                  <a class="btn btn-phoenix-secondary btn-icon fs-10 text-danger px-0 <%= showForUser %>" href="/delete/task/<%= item._id %>" data-event-propagation-prevent="data-event-propagation-prevent"><span class="fas fa-trash"></span></a>
                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="task<%= index %>" tabindex="<%= index %>" aria-hidden="true">
            <div class="modal-dialog modal-xl">
              <div class="modal-content bg-body overflow-hidden">
                <div class="modal-header px-6 py-5 pe-sm-5 px-md-6 dark__bg-gray-1100">
                  <h3 class="text-body-highlight fw-bolder mb-0"><%= item.name %></h3>
                  <button class="btn btn-phoenix-secondary btn-icon btn-icon-xl flex-shrink-0" type="button" data-bs-dismiss="modal" aria-label="Close"><span class="fa-solid fa-xmark"></span></button>
                </div>
                <div class="modal-body bg-body-highlight px-6 py-0">

                  <form class="row gx-14" action="/update/task/<%= item._id %>" method="post">

                    <div class="col-12 col-lg-7 border-end-lg">
                      <div class="py-6">
                        <div class="mb-7">
                          <div class="d-flex align-items-center mb-3">
                            <h4 class="me-3">Description</h4><a class="btn btn-link text-decoration-none p-0" data-bs-target="#description<%= index %>" data-bs-toggle="modal"><span class="fa-solid fa-pen"></span></a>
                          </div>
                          <p class="text-body-highlight mb-0"><%= item.description %></p>
                        </div>

                        <%
                              const formatDateFile = (date) => {
                                const options = { day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric', hour12: true };
                                const formattedDate = new Intl.DateTimeFormat('en-US', options).format(date);
                              
                                // Add day suffix (st, nd, rd, or th)
                                const day = date.getDate();
                                const daySuffix = (day) => {
                                  if (day >= 11 && day <= 13) {
                                    return 'th';
                                  }
                                  const lastDigit = day % 10;
                                  switch (lastDigit) {
                                    case 1: return 'st';
                                    case 2: return 'nd';
                                    case 3: return 'rd';
                                    default: return 'th';
                                  }
                                };
                              
                                return formattedDate.replace(/(\d+)/, (match, p1) => `${p1}${daySuffix(day)}`);
                              };
                            %>
                        <div class="mb-7">
                          <h4 class="mb-3">Subtasks</h4>

                          <% if(item.subtask && item.subtask.length > 0){ %>
                          <% const lastSubtaskIndex = item.subtask.length - 1 ; %>
                          <% item.subtask.forEach((subtask,index) => { %>

                          <%
                                var subtaskBorder = '';
                                if(index === lastSubtaskIndex) {
                                  subtaskBorder = 'border-bottom';
                                } else {
                                  subtaskBorder = '';
                                }
                                %>
                          <div class="d-flex flex-between-center hover-actions-trigger py-3 border-top <%= subtaskBorder %> mb-3">
                            <div class="form-check mb-1 mb-md-0 d-flex align-items-center lh-1 min-h-auto">
                              <input class="subtask-checkbox form-check-input form-check-line-through mt-0 me-3" type="checkbox" name="subtaskCheckbox" value="<%= subtask._id %>" />
                              <label class="form-check-label mb-0 fs-8" for="subtaskundefined1"><%= subtask.name %></label>
                            </div>
                            <div class="hover-actions end-0">
                              <button class="btn btn-sm me-1 fs-10 text-body-tertiary px-0 me-3"><span class="fa-solid fa-pencil"></span></button>
                              <button class="btn btn-sm text-body-tertiary px-0"><span class="fa-solid fa-xmark fs-8"></span></button>
                            </div>
                          </div>
                          <% }); %>
                          <% }else { %>
                          <p>There is no subtask.</p>
                          <% } %>
                          <a class="fw-bold fs-9" href="#!" data-bs-target="#subtask<%= index %>" data-bs-toggle="modal"><span class="fas fa-plus me-1"></span>Add subtask</a>
                        </div>

                        <div class="mb-3">
                          <div>
                            <h4 class="mb-3">Files</h4>
                          </div>

                          <% const modalFiles = files.filter((file) => file.uuid === item.fileId); %>
                          <% const lastIndexFile = modalFiles.length - 1; var borderModalFile = ''; %>
                          <% if(modalFiles && modalFiles.length > 0){ %>
                          <% modalFiles.forEach((file, index) => { %>

                          <% 
                                if(index === lastIndexFile){
                                    borderModalFile = 'border-bottom';
                                } else {
                                    borderModalFile = '';
                                }
                              %>

                          <% if(file.type === '.png' || file.type === '.webp' || file.type === '.jpg' || file.type === '.jpeg' || file.type === '.gif' ){ %>
                          <div class="border-top <%= borderModalFile %> px-0 pt-4 pb-3">
                            <div class="me-n3">
                              <div class="d-flex flex-between-center">
                                <div class="d-flex mb-1"><span class="fa-solid fa-image me-2 text-body-tertiary fs-9"></span>
                                  <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                                </div>
                                <div class="btn-reveal-trigger">
                                  <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                                  <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item text-danger" href="/files/delete/<%= file._id %>">Delete</a><a class="dropdown-item" href="/files/download/<%= file._id %>">Download</a><a class="dropdown-item d-none" href="#!">Report abuse</a></div>
                                </div>
                              </div>
                              <div class="d-flex fs-9 text-body-tertiary mb-2 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="#!"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div><img class="rounded-2" src="<%= file.path %>" alt="" style="max-width:230px" />
                            </div>
                          </div>

                          <% }else { %>

                          <div class="border-top <%= borderModalFile %> px-0 pt-4 pb-3">
                            <div class="me-n3">
                              <div class="d-flex flex-between-center">
                                <div>
                                  <div class="d-flex align-items-center mb-1"><span class="fa-solid fa-image me-2 fs-9 text-body-tertiary"></span>
                                    <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                                  </div>
                                  <div class="d-flex fs-9 text-body-tertiary mb-0 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="#!"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div>
                                </div>
                                <div class="btn-reveal-trigger">
                                  <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                                  <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item" href="#!">Edit</a><a class="dropdown-item text-danger" href="/">Delete</a><a class="dropdown-item" href="#!">Download</a><a class="dropdown-item" href="#!">Report abuse</a></div>
                                </div>
                              </div>
                            </div>
                          </div>

                          <% } %>
                          <% }); %>
                          <% }else { %>
                          <p>There is no file uploaded.</p>
                          <% } %>
                        </div><a class="fw-bold fs-9" href="#!" data-bs-target="#file<%= index %>" data-bs-toggle="modal"><span class="fas fa-plus me-1"></span>Add file(s)</a>
                      </div>
                    </div>

                    <div class="col-12 col-lg-5">
                      <div class="py-6">
                        <h4 class="mb-4 text-body-emphasis">Others Information</h4>
                        <h5 class="text-body-highlight mb-2">Status</h5>
                        <select class="form-select mb-4" aria-label="Default select example" name="status">
                          <option selected="" value="">Select</option>
                          <option value="process">Process</option>
                          <option value="done">Done</option>
                          <option value="cancelled">Cancelled</option>
                          <option value="urgent">Urgent</option>
                        </select>
                        <h5 class="text-body-highlight mb-2">Due Date</h5>
                        <div class="flatpickr-input-container mb-4">
                          <input class="form-control datetimepicker ps-6" type="text" name="due" placeholder="Set the due date" data-options='{"disableMobile":true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                        </div>
                        <h5 class="text-body-highlight mb-2">Reminder</h5>
                        <div class="flatpickr-input-container mb-4">
                          <input class="form-control datetimepicker ps-6 w-100" type="text" name="reminder" placeholder="Set reminder" data-options='{"disableMobile":true, "enableTime": true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                        </div>
                        <div class="text-end mb-9 d-flex">
                          <button class="btn btn-phoenix-primary loading-button" type="submit">
                            <div class="content-button">
                              <span>Update Task</span>
                            </div>
                          </button>
                          <a role="button" class="btn btn-phoenix-danger <%= showForUser %>" href="/delete/task/<%= item._id %>">Delete Task</a>
                        </div>
                      </div>
                    </div>

                  </form>

                </div>
              </div>
            </div>
          </div>

          <div class="modal fade" id="description<%= index %>" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-md">
              <div class="modal-content px-2 py-3">
                <form action="/update/description/<%= item._id %>" method="post">
                  <div class="modal-body">
                    <label class="form-label" for="udpateDescription">Description</label>
                    <textarea class="form-control scrollbar-overlay" id="udpateDescription" placeholder="Leave a description here" style="height: 100px" name="description"></textarea>
                  </div>
                  <div class="modal-footer border-top-0">
                    <button class="btn btn-primary loading-button" type="submit">
                      <div class="content-button">
                        <span>Update</span>
                      </div>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="modal fade" id="subtask<%= index %>" aria-hidden="true" aria-labelledby="" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <form action="/update/subtask/<%= item._id %>" method="post">
                  <div class="modal-body">
                    <label class="form-label" for="updateSubtask">Subtask</label>
                    <input class="form-control" type="text" id="updateSubtask" name="subtask" placeholder="Add subtask here">
                  </div>
                  <div class="modal-footer border-top-0">
                    <button class="btn btn-primary loading-button" type="submit">
                      <div class="content-button">
                        <span>Add subtask</span>
                      </div>
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="modal fade" id="file<%= index %>" aria-hidden="true" aria-labelledby="taskFile" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-md">
              <div class="modal-content px-2 py-3">

                <div class="modal-body">
                  <form class="dropzone dropzone-multiple p-3 mb-4 bg-subtle" id="dropzone<%= index %>" data-dropzone="data-dropzone" action="/update/file/<%= item._id %>" data-options='{"url":"/update/file/<%= item._id %>","paramName": "file"}'>
                    <div class="dz-message" data-dz-message="data-dz-message">
                      <img class="me-2" src="../../../assets/img/icons/cloud-upload.svg" width="25" alt="" />Drop your files here
                    </div>
                    <div class="dz-preview dz-preview-multiple m-0 d-flex flex-column">
                      <div class="d-flex mb-3 pb-3 border-bottom media">
                        <div class="border border-300 p-1 rounded-2 me-2">
                          <img class="rounded-2 dz-image" src="../../../assets/img/icons/file.png" alt="..." data-dz-thumbnail="data-dz-thumbnail" />
                        </div>
                        <div class="flex-1 d-flex flex-between-center">
                          <div>
                            <h6 data-dz-name="data-dz-name"></h6>
                            <div class="d-flex align-items-center">
                              <p class="mb-0 fs-9 text-400 lh-1" data-dz-size="data-dz-size"></p>
                              <div class="dz-progress ms-n1" style="margin-top: 0.1rem;">
                                <span class="dz-upload" data-dz-uploadprogress=""></span>
                              </div>
                            </div>
                            <span class="fs-9 text-danger" data-dz-errormessage="data-dz-errormessage"></span>
                          </div>
                          <div class="dropdown font-sans-serif">
                            <button class="btn btn-link text-600 btn-sm dropdown-toggle btn-reveal dropdown-caret-none" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                              <span class="fas fa-ellipsis-h"></span>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end border py-2">
                              <a class="dropdown-item" href="#!" data-dz-remove="data-dz-remove">Remove File</a>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <input class="d-none" type="text" name="origin" value="task">
                    <input type="hidden" name="uuid" value="<%= item.fileId %>">
                  </form>
                </div>
                <div class="modal-footer border-top-0">
                  <button class="btn btn-phoenix-primary" type="button" data-bs-target="#task<%= index %>" data-bs-toggle="modal">Back</button>
                  <button class="btn btn-phoenix-primary loading-upload-button" type="submit" id="uploadFiles<%= index %>">
                    <div class="content-upload-button">
                      <span><i class="fa fa-upload me-2" aria-hidden="true"></i>Upload Files</span>
                    </div>
                  </button>
                </div>

                <script>
                  // upload files
                  $(document).ready(function() {
                    // Function to show the toast
                    function showDropzoneFilesToast(content) {
                      $('#dropzoneAlertContent').text(content);

                      var toast = new bootstrap.Toast(
                        document.getElementById('alertUploadToast')
                      );
                      toast.show();
                    }

                    var myDropzone = Dropzone.forElement('#dropzone<%= index %>');

                    $('#uploadFiles<%= index %>').on('click', function() {
                      setTimeout(function() {
                        // files upload process queue

                        if (myDropzone.getQueuedFiles().length > 0) {
                          // If files are present, show the toast with appropriate content
                          showDropzoneFilesToast('Files has been uploaded');
                          // Process the Dropzone queue
                          myDropzone.processQueue();

                          $('#file<%= index %>').modal('hide');

                          setTimeout(function() {
                            window.location.href = '/';
                          }, 2000);

                        } else {
                          // If no files are present, show the toast with different content
                          showDropzoneFilesToast('No files selected');
                        }

                        button.prop('type', 'submit');
                      }, 1000);
                    });
                  });
                </script>

              </div>
            </div>
          </div>

          <% }); %>
          <% } else { %>
          <p>There is not task assigned to you.</p>
          <% } %>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function() {
            const searchInput = document.getElementById("searchInput");
            const items = document.getElementsByClassName("item");

            // Add event listener for the search input
            searchInput.addEventListener("input", function() {
              const keyword = searchInput.value.toLowerCase();

              // Loop through the list items and show/hide based on the keyword
              for (let i = 0; i < items.length; i++) {
                const itemName = items[i].getElementsByClassName("itemName")[0].innerText.toLowerCase();
                const itemDate = items[i].getElementsByClassName("itemDate")[0].innerText.toLowerCase();
                const itemTime = items[i].getElementsByClassName("itemTime")[0].innerText.toLowerCase();
                const itemStatus = items[i].getElementsByClassName("itemStatus")[0].innerText.toLowerCase();

                if (itemName.includes(keyword) || itemDate.includes(keyword) || itemTime.includes(keyword) || itemStatus.includes(keyword)) {
                  items[i].style.display = "block";
                } else {
                  items[i].style.display = "none";
                }
              }
            });
          });
        </script>

        <div class="card-footer border-0"><a class="fw-bold fs-9 mt-4" href="#!" data-bs-toggle="modal" data-bs-target="#addTask"><span class="fas fa-plus me-1"></span>Add new task</a></div>

        <div class="modal fade" id="addTask" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-md">

            <div class="modal-content">

              <div class="modal-header px-6 py-5 pe-sm-5 px-md-6 dark__bg-gray-1100">
                <h3 class="text-body-highlight fw-bolder mb-0">Task Submission</h3>
                <button class="btn btn-phoenix-secondary btn-icon btn-icon-xl flex-shrink-0" type="button" data-bs-dismiss="modal" aria-label="Close"><span class="fa-solid fa-xmark"></span></button>
              </div>


              <div class="modal-body bg-body-highlight px-6 py-2 rounded-bottom-3">
                <form class="row g-3" action="/task/add" method="post" id="taskForm">

                  <div class="col-12">
                    <label for="taskName" class="form-label">Task Name</label>
                    <input class="form-control" type="text" name="name" placeholder="Please enter task name here" id="taskName" />
                  </div>

                  <div class="col-12">
                    <label class="form-label" for="addDescription">Description</label>
                    <textarea class="form-control scrollbar-overlay" id="addDescription" placeholder="Leave a description here" style="height: 100px" name="description"></textarea>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="taskStatus" class="form-label">Status</label>
                    <select class="form-select mb-4" id="taskStatus" aria-label="Default select example" name="status">
                      <option selected="" value="">Select</option>
                      <option value="process">Process</option>
                      <option value="done">Done</option>
                      <option value="cancelled">Cancelled</option>
                      <option value="urgent">Urgent</option>
                    </select>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="taskDue" class="form-label">Due</label>
                    <div class="flatpickr-input-container">
                      <input class="form-control datetimepicker ps-6" type="text" name="due" placeholder="Set the due date" id="taskDue" data-options='{"disableMobile":true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                    </div>
                  </div>

                  <div class="col-12 col-md-4">
                    <label for="taskReminder" class="form-label">Reminder</label>
                    <div class="flatpickr-input-container">
                      <input class="form-control datetimepicker ps-6 w-100" type="text" name="reminder" placeholder="Set reminder" id="taskReminder" data-options='{"disableMobile":true, "enableTime": true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                    </div>
                  </div>

                  <div class="col-md-12 mt-0 mb-3">
                    <h4 class="form-label">Staff Assigned</h4>
                    <div id="selectedNames" class="d-flex flex-wrap border border-300 rounded-3 px-2" style="min-height: 2.5rem"></div>
                  </div>


                  <div class="col-md-12 mt-0">
                    <div class="row">
                      <div class="col-6">
                        <label class="form-label" for="validationCustom03">Search Staff Name</label>
                        <input type="text" name="query" id="queryInput" class="form-control" placeholder="Search and click staff name" />
                        <div class="invalid-feedback">
                          Please search and click staff assigned.
                        </div>
                        <div class="valid-feedback">Looks good!</div>
                      </div>

                      <div id="results" class="mt-3 mb-3 col-12"></div>
                    </div>
                  </div>

                  <input type="hidden" id="selectedNamesInput" name="selectedNames" value="<%= Array.isArray(selectedNames) ? selectedNames.join(',') : '' %>" />
                  <input type="hidden" name="uuid" value="<%= uuid %>">
                  <div class="col-auto mb-6 d-flex">
                    <button class="btn btn-phoenix-primary loading-button" type="submit">
                      <div class="content-button">
                        <span>Add Task</span>
                      </div>
                    </button>

                    <a class="fw-bold fs-9 my-auto ms-4" href="#!" data-bs-target="#addTaskFiles" data-bs-toggle="modal"><span class="fas fa-plus me-1"></span>Add file(s)</a>
                  </div>
                </form>

                <script>
                  $(document).ready(function() {
                    const queryInput = $('#queryInput');
                    const selectedNamesDiv = $('#selectedNames');
                    const reportIdInput = $('#reportIdInput');
                    const displayNamesContainer = $('#displayNamesContainer');
                    const selectedNames = [];

                    $('#taskForm input[name="query"]').on('input', function() {
                      const query = $(this).val();
                      if (query.trim() !== '') {
                        $.ajax({
                          url: `/search/staff/assignee-relief?query=${query}`,
                          method: 'GET',
                          success: function(results) {
                            displayResults(results);
                          },
                          error: function(error) {
                            console.error(error);
                          }
                        });
                      } else {
                        // Clear results if the search query is empty
                        displayResults([]);
                      }
                    });

                    function displayResults(results) {
                      const resultsDiv = $('#results');
                      resultsDiv.empty();

                      if (results.length === 0) {
                        resultsDiv.append('<p class="text-muted">No results found</p>');
                      } else {
                        results.forEach(result => {
                          const resultDiv = $(
                            '<div class="result btn btn-outline-primary mr-2 mb-2"></div>'
                          ).text(result.fullname);
                          resultsDiv.append(resultDiv);

                          // Add click event to handle adding and removing names
                          resultDiv.click(function() {
                            const clickedName = result.fullname;

                            // Check if the name is already selected
                            const index = selectedNames.indexOf(clickedName);
                            if (index === -1) {
                              // If not selected, add it to the array and update the display
                              selectedNames.push(clickedName);
                              updateSelectedNamesDisplay();
                            } else {
                              // If already selected, remove it from the array and update the display
                              selectedNames.splice(index, 1);
                              updateSelectedNamesDisplay();
                            }
                          });
                        });
                      }
                    }

                    function updateSelectedNamesDisplay() {
                      // Update the display with the selected names
                      selectedNamesDiv.empty();
                      selectedNames.forEach(name => {
                        const nameDiv = $(
                          '<div class="selectedName btn btn-outline-secondary mr-2 mb-1 mt-1"></div>'
                        ).text(name);
                        selectedNamesDiv.append(nameDiv);

                        // Add click event to remove the name
                        nameDiv.click(function() {
                          const removedName = $(this).text();
                          const index = selectedNames.indexOf(removedName);
                          selectedNames.splice(index, 1);
                          updateSelectedNamesDisplay();
                        });
                      });

                      // Update the hidden input value with selected names
                      $('#selectedNamesInput').val(selectedNames.join(','));
                    }
                  });
                </script>
              </div>

            </div>
          </div>
        </div>

        <div class="modal fade" id="addTaskFiles" aria-hidden="true" aria-labelledby="taskFile" tabindex="-1">
          <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content px-2 py-3">
              <div class="modal-body">
                <form class="dropzone dropzone-multiple p-3 mb-4 bg-subtle" id="dropzone" data-dropzone="data-dropzone" action="/files/upload" data-options='{"url":"/files/upload","paramName": "file"}'>
                  <div class="dz-message" data-dz-message="data-dz-message">
                    <img class="me-2" src="../../../assets/img/icons/cloud-upload.svg" width="25" alt="" />Drop your files here
                  </div>
                  <div class="dz-preview dz-preview-multiple m-0 d-flex flex-column">
                    <div class="d-flex mb-3 pb-3 border-bottom media">
                      <div class="border border-300 p-1 rounded-2 me-2">
                        <img class="rounded-2 dz-image" src="../../../assets/img/icons/file.png" alt="..." data-dz-thumbnail="data-dz-thumbnail" />
                      </div>
                      <div class="flex-1 d-flex flex-between-center">
                        <div>
                          <h6 data-dz-name="data-dz-name"></h6>
                          <div class="d-flex align-items-center">
                            <p class="mb-0 fs-9 text-400 lh-1" data-dz-size="data-dz-size"></p>
                            <div class="dz-progress ms-n1" style="margin-top: 0.1rem;">
                              <span class="dz-upload" data-dz-uploadprogress=""></span>
                            </div>
                          </div>
                          <span class="fs-9 text-danger" data-dz-errormessage="data-dz-errormessage"></span>
                        </div>
                        <div class="dropdown font-sans-serif">
                          <button class="btn btn-link text-600 btn-sm dropdown-toggle btn-reveal dropdown-caret-none" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="fas fa-ellipsis-h"></span>
                          </button>
                          <div class="dropdown-menu dropdown-menu-end border py-2">
                            <a class="dropdown-item" href="#!" data-dz-remove="data-dz-remove">Remove File</a>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <input class="d-none" type="text" name="origin" value="task">
                  <input class="d-none" type="text" name="uuid" value="<%= uuid %>">

                </form>
              </div>
              <div class="modal-footer border-top-0">
                <button class="btn btn-phoenix-primary" type="button" data-bs-target="#addTask" data-bs-toggle="modal">Back</button>
                <button class="btn btn-phoenix-primary loading-upload-button" type="submit" id="uploadFiles">
                  <div class="content-upload-button">
                    <span><i class="fa fa-upload me-2" aria-hidden="true"></i>Upload Files</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        function filterTasksByKeyword(keyword) {
          // Get all elements with class "task-list-body"
          var tasks = document.querySelectorAll('.task-list-body');

          // Loop through each task
          tasks.forEach(function(task) {
            // Check if the task contains the keyword in task-name, date, or time
            var taskName = task.querySelector('.task-name').textContent.toLowerCase();
            var date = task.querySelector('.date').textContent.toLowerCase();
            var time = task.querySelector('.time').textContent.toLowerCase();
            var taskId = task.id;

            // Check if the task ID matches the keyword or task name, date, or time contains the keyword
            if (taskName.includes(keyword) || date.includes(keyword) || time.includes(keyword)) {
              task.id.style.display = 'block'; // Show the task
            } else if (taskName.split(' ').some(word => word.includes(keyword))) {
              task.id.style.display = 'block'; // Show the task if any word in task name matches the keyword
            } else {
              task.id.style.display = 'none'; // Hide the task
            }
          });
        }

        // Add an event listener to the search input field
        var searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('input', function() {
          var searchTerm = searchInput.value.toLowerCase();
          filterTasksByKeyword(searchTerm);
        });

        // Example usage
        // filterTasksByKeyword('task-1');
      </script>

    </div>

    <div class="col-12 col-xl-6 col-xxl-5 mb-3">
      <div class="card overflow-y-auto scrollbar" style="height: 50vh;">
        <div class="card-body">
          <div class="card-title mb-1">
            <h3 class="text-body-emphasis">Activity</h3>
          </div>
          <p class="text-body-tertiary mb-4">Recent activity accross your department</p>

          <% 

          var userActivities = '';
          if(user.isChiefExec || user.isDeputyChiefExec){
            userActivities = activities.filter(activity => activity.user.isManagement === user.isManagement);
          } else if (user.isHeadOfDepartment){
            userActivities = activities.filter(activity => activity.user.department === user.department);
          } else if (user.isPersonalAssistant){
            userActivities = activities.filter(activity => activity.isAdmin === user.isAdmin && activity.user.section === user.section);
          } else {
            userActivities = activities.filter(activity => activity.user.section === user.section);
          }

          %>
          <div class="timeline-vertical timeline-with-details">
            <% if(userActivities&& userActivities.length >0){%>
            <% const lastActivitiesIndex = userActivities.length - 1; %>
            <% userActivities.forEach(function(activity, index) { %>

            <% 
                var borderActivity = '';

                if(index  === lastActivitiesIndex) {
                    borderActivity = 'd-none';
                }else {
                    borderActivity = '';
                }
            %>

            <div class="timeline-item position-relative">
              <div class="row g-md-3">
                <div class="col-12 col-md-auto d-flex">
                  <div class="timeline-item-date order-1 order-md-0 me-md-4">
                    <p class="fs-10 fw-semibold text-body-tertiary text-opacity-85 text-end"><%= activity.date.toLocaleDateString('en-US', { day: '2-digit', month: 'short', year: 'numeric', timeZone : 'Asia/Kuala_Lumpur' }) %><br class="d-none d-md-block" /> <%= activity.date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone : 'Asia/Kuala_Lumpur' }) %></p>
                  </div>
                  <div class="timeline-item-bar position-md-relative me-3 me-md-0">
                    <div class="icon-item icon-item-sm rounded-7 shadow-none bg-primary-subtle"><span class="fa-solid fa-chess text-primary-dark fs-10"></span></div><span class="timeline-bar border-end border-dashed <%= borderActivity %>"></span>
                  </div>
                </div>
                <div class="col">
                  <div class="timeline-item-content ps-6 ps-md-3">
                    <h5 class="fs-9 lh-sm"><%= activity.title %></h5>
                    <p class="fs-9">by <a class="fw-semibold" href="#!"><%= activity.user.fullname %></a></p>
                    <p class="fs-9 text-body fst-italic mb-5"><%= activity.description %></p>
                  </div>
                </div>
              </div>
            </div>
            <%  }) %>
            <% }else { %>
            <p>There is no activity yet.</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mx-n4 px-4 mx-lg-n6 px-lg-6 bg-body-emphasis pt-7 pb-3 border-y mb-6 row g-3">

  <div class="col-12 col-xxl-4 mb-3">

    <% 
        var genderFemale = '';
        if (userLeave.user.gender === 'Male') {
          genderFemale = 'd-none';
        } else if (userLeave.user.gender === 'Female' && userLeave.maternity.taken > 0) {
          genderFemale = '';
        } else {
          genderFemale = '';
        }

        var genderMale = '';
        if (userLeave.user.gender === 'Female' || userLeave.paternity.taken > 6) {
          genderMale = 'd-none';
        } else {
          genderMale = '';
        }

        var marriage = '';
        if (userLeave.marriage.taken > 0) {
          marriage = 'd-none';
        } else {
          marriage = '';
        }

        var hajj = '';
        if (userLeave.hajj.taken > 0) {
          hajj = 'd-none';
        } else {
          hajj = '';
        }

        var special = '';
        if (userLeave.special.taken > 7) {
          special = 'd-none';
        } else {
          special = '';
        }   
    %>

    <div class="row g-3 mb-3">
      <div class="col-12 col-md-6">
        <h3 class="text-body-emphasis text-nowrap">Leave Balances</h3>
        <p class="text-body-tertiary mb-md-7"></p>
        <div class="d-flex align-items-center justify-content-between">
          <p class="mb-0 fw-bold">Leave Type </p>
        </div>
        <hr class="bg-body-secondary mb-2 mt-2" />
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-info-light bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Annual Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.annual.leave - userLeave.annual.taken %></h5>
        </div>
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-warning-darker bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Sick Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.sick.leave - userLeave.sick.taken %></h5>
        </div>
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-warning-light bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Sick Extended Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.sickExtended.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-danger-light bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Emergency Leave Taken</p>
          <h5 class="mb-0 text-body"><%= userLeave.emergency.taken %></h5>
        </div>
        <div class="d-flex align-items-center mb-1 <%= marriage %>"><span class="d-inline-block bg-danger-dark bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Marriage Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.marriage.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1 <%= genderMale %>"><span class="d-inline-block bg-success-light bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Paternity Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.paternity.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1 <%= genderFemale %>"><span class="d-inline-block bg-success-dark bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Maternity Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.maternity.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-info-dark bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Attend Exam Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.attendExam.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1 <%= hajj %>"><span class="d-inline-block bg-info-lighter bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Hajj Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.hajj.leave %></h5>
        </div>
        <div class="d-flex align-items-center mb-1"><span class="d-inline-block bg-primary bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Unpaid Leave Taken</p>
          <h5 class="mb-0 text-body"><%= userLeave.unpaid.taken %></h5>
        </div>
        <div class="d-flex align-items-center mb-1 <%= special %>"><span class="d-inline-block bg-warning-lighter bullet-item me-2"></span>
          <p class="mb-0 fw-semibold text-body lh-sm flex-1">Special Leave</p>
          <h5 class="mb-0 text-body"><%= userLeave.special.leave %></h5>
        </div>
        <a class="btn btn-outline-primary mt-5" href="/leave/history">See History<span class="fas fa-angle-right ms-2 fs-10 text-center"></span></a>
      </div>
      <div class="col-12 col-md-6">
        <div class="position-relative mb-sm-2 mb-xl-0">
          <div class="ms-xxl-5 my-xxl-auto mt-xxl-5" id="leave-type-chart" style="height:400px;"></div>
        </div>
      </div>
    </div>

    <script>
      fetch(leaveTypeURL)
        .then(response => response.json())
        .then(fetchLeaveTypeData => {
          updateLeaveTypeChart(fetchLeaveTypeData, 'leave-type-chart');
        })
        .catch(error => {
          console.error('Error fetching user leave data:', error);
        });

      function updateLeaveTypeChart(fetchLeaveTypeData, echartsId) {

        var genderFemale = '';
        if (fetchLeaveTypeData.user.gender === 'Male') {
          genderFemale = 60;
        } else if (fetchLeaveTypeData.user.gender === 'Female' && fetchLeaveTypeData.maternity.taken > 0) {
          genderFemale = 60;
        } else {
          genderFemale = 0;
        }

        var genderMale = '';
        if (fetchLeaveTypeData.user.gender === 'Female' || fetchLeaveTypeData.paternity.taken > 6) {
          genderMale = 3;
        } else {
          genderMale = 0;
        }

        var marriage = '';
        if (fetchLeaveTypeData.marriage.taken > 0) {
          marriage = 3;
        } else {
          marriage = 0;
        }

        var hajj = '';
        if (fetchLeaveTypeData.hajj.taken > 0) {
          hajj = 40;
        } else {
          hajj = 0;
        }

        var special = '';
        if (fetchLeaveTypeData.special.taken > 7) {
          special = 3;
        } else {
          special = 0;
        }

        var leaveTypeData = {
          labels: ['Annual Leave', 'Sick Leave', 'Sick Extended Leave', 'Emergency Leave Taken', 'Marriage Leave', 'Paternity Leave', 'Maternity Leave', 'Attend Exam Leave', 'Hajj Leave', 'Unpaid Leave Taken', 'Special Leave'],
          data: [
            fetchLeaveTypeData.annual.leave - fetchLeaveTypeData.annual.taken,
            fetchLeaveTypeData.sick.leave - fetchLeaveTypeData.sick.taken,
            fetchLeaveTypeData.sickExtended.leave - fetchLeaveTypeData.sickExtended.taken,
            fetchLeaveTypeData.emergency.taken,
            fetchLeaveTypeData.marriage.leave - marriage,
            fetchLeaveTypeData.paternity.leave - genderMale,
            fetchLeaveTypeData.maternity.leave - genderFemale,
            fetchLeaveTypeData.attendExam.leave - fetchLeaveTypeData.attendExam.taken,
            fetchLeaveTypeData.hajj.leave - hajj,
            fetchLeaveTypeData.unpaid.taken,
            fetchLeaveTypeData.special.leave - special,
          ],
        };
        // Initialize ECharts instance
        var leaveTypeChart = echarts.init(document.getElementById(echartsId), null, {
          devicePixelRatio: window.devicePixelRatio > 1 ? 2 : 1,
          renderer: 'canvas',
          width: 'auto',
          height: 'auto'
        });

        var option = {
          color: [getColor('bg-info-light', 'background-color'), getColor('bg-warning-darker', 'background-color'),
            getColor('bg-warning-light', 'background-color'), getColor('bg-danger-light', 'background-color'), getColor('bg-danger-dark', 'background-color'), getColor('bg-success-light', 'background-color'),
            getColor('bg-success-dark', 'background-color'), getColor('bg-info-dark', 'background-color'), getColor('bg-info-lighter', 'background-color'), getColor('bg-primary', 'background-color'), getColor('bg-warning-lighter', 'background-color')
          ],
          series: [{
            name: 'Tasks assigned to me',
            type: 'pie',
            radius: ['70%', '85%'],
            startAngle: 30,
            avoidLabelOverlap: false,
            label: {
              show: false,
              position: 'center',
              formatter: '{x|{c} } \n {y|{b}}',
              rich: {
                x: {
                  fontSize: 31.25,
                  fontWeight: 800,
                  color: '#3874ff',
                  padding: [0, 0, 5, 15]
                },
                y: {
                  fontSize: 12,
                  color: '#3874ff',
                  fontWeight: 600
                }
              }
            },
            emphasis: {
              label: {
                show: true
              }
            },
            // itemStyle: {
            //   borderWidth: 1, 
            //   borderColor: getColor('bg-body', 'background-color'), 
            // },
            labelLine: {
              show: false
            },
            data: leaveTypeData.labels.map((label, index) => ({
              value: leaveTypeData.data[index],
              name: label,
              emphasis: index === 0 ? {
                label: {
                  show: true,
                },
              } : {},
            })),
          }, ],
          grid: {
            bottom: 0,
            top: 0,
            left: 0,
            right: 0,
            containLabel: false
          },
        };

        leaveTypeChart.setOption(option);

        window.addEventListener('resize', function() {
          leaveTypeChart.resize();
        });

      }
    </script>
  </div>

  <div class="col-12 col-xxl-8 mb-3 px-xxl-5">
    <div class="card mt-xxl-8" style="height: 350px;">
      <div class="bg-holder d-block bg-card" style="background-image:url(/assets/img/spot-illustrations/32.png);background-position: top right;">
      </div>
      <div class="card-body">
        <div class="card-title">
          <h5 class="badge badge-phoenix badge-phoenix-warning"><span class="me-2 fa-solid fa-ribbon"></span>Coming Soon</h5>

          <h3 class="mt-5">Full Calendar</h3>
          <p class="fw-normal fs-8">is a versatile JavaScript library for creating interactive calendars. It supports dynamic event rendering, drag-and-drop functionality, various views, and customization options, making it ideal for diverse scheduling needs</p>
        </div>
      </div>
    </div>
  </div>

</div>

<div class="mb-3 row g-3">
  <div class="col-12">
    <div class="card pt-3 min-vh-25">
      <div class="card-body">
        <div id="leave-approvals" data-list='{"valueNames":["type","staff","startdate","returndate","latestapproval","status"],"page":10,"pagination":true}'>
          <div class="row align-items-end justify-content-between pb-4 g-3">

            <div class="col-auto">
              <h3>Leave Approvals</h3>
              <p class="text-body-tertiary lh-sm mb-0">Permission granted, absence authorized, leave request accepted.</p>
            </div>

            <div class="col-12 col-md-auto">
              <div class="search-box px-lg-0 pe-4">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                  <input class="form-control search-input search form-control-sm" type="search" placeholder="Search leave approval" aria-label="Search" />
                  <span class="fas fa-search search-box-icon"></span>
                </form>
              </div>
            </div>

          </div>
          <div class="table-responsive ms-n1 ps-1 scrollbar">
            <table class="table fs-9 mb-0 border-top border-translucent">
              <thead>
                <tr>
                  <th class="sort white-space-nowrap align-middle ps-0" scope="col" data-sort="type" style="width:10%;">TYPE</th>
                  <th class="sort align-middle ps-3" scope="col" data-sort="staff" style="width:15%;">STAFF</th>
                  <th class="sort align-middle ps-3" scope="col" data-sort="latestapproval" style="width:20%;">LATEST APPROVAL</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="startdate" style="width:10%;">START DATE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="returndate" style="width:10%;">RETURN DATE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="status" style="width:10%;">STATUS</th>
                  <th class="sort align-middle text-end" scope="col" style="width:5%;"></th>
                </tr>
              </thead>

              <% 
                  function formatDate(inputDate) {
                    const day = String(inputDate.getDate()).padStart(2, '0');
                    const month = String(inputDate.getMonth() + 1).padStart(2, '0');
                    const year = inputDate.getFullYear();
                  
                    return `${day}/${month}/${year}`;
                  }
              %>

              <tbody class="list" id="leave-approvals-table">
                <% if (filteredApprovalLeaves && filteredApprovalLeaves.length > 0) { %>
                <!-- table item -->
                <% filteredApprovalLeaves.forEach(function(leaves) { %>

                <% 
                      
                var statusApprovalColor = '';
                if (leaves.status == "pending"){
                    statusApprovalColor = 'info';
                } else if(leaves.status == "approved") {
                    statusApprovalColor = 'success';
                } else if(leaves.status == "denied" ||  leaves.status == "cancelled") {
                    statusApprovalColor = 'danger';
                }else if (leaves.status == "invalid"){
                    statusApprovalColor = 'warning';
                }else if (leaves.status == "submitted"){
                    statusApprovalColor = 'info';
                }
                                    
                %>

                <tr class="position-static">
                  <td class="align-middle white-space-nowrap ps-0 type py-4">
                    <a class="fw-bold fs-8" href="/leave/details/<%= leaves._id %>"><%= leaves.type %></a>
                  </td>
                  <td class="align-middle white-space-nowrap ps-3 staff py-4">
                    <% const userApproval = allUser.find(userapp => userapp._id.toString() === leaves.user.toString()); %>
                    <a class="fw-bold fs-8" href="/staff/details/<%= leaves.user %>"><%= userApproval.fullname %></a>
                  </td>
                  <td class="align-middle latestapproval ps-3 py-4">
                    <% const latestApproval = leaves.approvals.reduce((latest, approval) => approval.timestamp > latest.timestamp ? approval : latest, leaves.approvals[0]); %>
                    <p class="fs-9 fw-semibold text-body-highlight mb-0 fst-italic">
                      <%= latestApproval.role %> has <%= latestApproval.status %> this <%= leaves.type %> at <%= latestApproval.timestamp.toLocaleDateString('en-UK', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric', 
                                    timeZone: 'Asia/Kuala_Lumpur' 
                                  }); %>
                    </p>
                  </td>
                  <td class="align-middle white-space-nowrap text-center startdate ps-0 py-4">
                    <p class="mb-0 fs-9 text-body"><%= formatDate(leaves.date.start) %></p>
                  </td>
                  <td class="align-middle white-space-nowrap text-center returndate ps-0 py-4">
                    <p class="mb-0 fs-9 text-body"><%= formatDate(leaves.date.return) %></p>
                  </td>
                  <td class="align-middle white-space-nowrap text-center status">
                    <span class="badge badge-phoenix fs-10 badge-phoenix-<%= statusApprovalColor %>"><%= leaves.status %></span>
                  </td>
                  <td class="align-middle text-end white-space-nowrap pe-0 action">
                    <div class="font-sans-serif btn-reveal-trigger position-static">
                      <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs--2" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
                        <span class="fas fa-ellipsis-h fs-9"></span>
                      </button>
                      <div class="dropdown-menu dropdown-menu-end py-2">
                        <a class="dropdown-item" href="/leave/details/<%= leaves._id %>">View</a>
                      </div>
                    </div>
                  </td>
                </tr>
                <%  }); %> <% } else { %>
                <tr>
                  <td>
                    <p class="align-middle fs-9 white-space-nowrap">No approvals leave here.</p>
                  </td>
                </tr>
                <% } %>
              </tbody>

            </table>
          </div>
          <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
            <div class="col-auto d-flex">
              <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
            </div>
            <div class="col-auto d-flex">
              <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
              <ul class="mb-0 pagination"></ul>
              <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mb-6 row g-3">

  <% 
  function formatDate(inputDate) {
    const day = String(inputDate.getDate()).padStart(2, '0');
    const month = String(inputDate.getMonth() + 1).padStart(2, '0');
    const year = inputDate.getFullYear();
  
    return `${day}/${month}/${year}`;
  }
  %>

  <div class="col-12 col-xxl-6">
    <div class="card pt-3" style="min-height: 35vh;">
      <div class="card-body">
        <div id="today-on-leave" class="leave-section" data-list='{"valueNames":["staff","type","startdate","returndate"],"page":4,"pagination":true}'>

          <div class="row align-items-end justify-content-between pb-4 g-3">

            <div class="col-12">
              <h3>Staff on leave today</h3>
              <p class="text-body-tertiary lh-sm mb-0">Employees absent today, leave granted.</p>
            </div>

            <div class="col-12 col-md-auto">
              <div class="search-box px-lg-0 pe-4">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                  <input class="form-control search-input search form-control-sm" type="search" placeholder="Search leave approval" aria-label="Search" />
                  <span class="fas fa-search search-box-icon"></span>
                </form>
              </div>
            </div>

          </div>

          <div class="table-responsive ms-n1 ps-1 scrollbar h-100">
            <table class="table fs-9 mb-0 border-top border-translucent">
              <thead>
                <tr>
                  <th class="sort white-space-nowrap align-middle text-start" scope="col" data-sort="staff" style="width:auto;">STAFF</th>
                  <th class="sort align-middle text-start" scope="col" data-sort="type" style="width:auto;">TYPE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="startdate" style="width:auto;">START DATE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="returndate" style="width:auto;">RETURN DATE</th>
                </tr>
              </thead>
              <tbody class="list" id="project-summary-table-body">
                <% if(todayLeaves && todayLeaves.length>0){ %>
                <% todayLeaves.forEach(onLeave => { %>

                <tr class="position-static">

                  <td class="align-middle text-body white-space-nowrap ps-0 staff">
                    <% const staffToday = allUser.find(staff => staff._id.toString() === onLeave.user.toString()); %>
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/staff/details/<%= onLeave.user %>"><%= staffToday.fullname %></a>
                  </td>


                  <td class="align-middle text-body white-space-nowrap ps-0 type">
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/leave/details/<%= onLeave._id %>"><%= onLeave.type %></a>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 startdate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.start) %></p>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 returndate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.return) %></p>
                  </td>
                </tr>
                <% }); %>
                <% }else { %>
                <tr class="position-static">
                  <td class="align-middle white-space-nowrap">
                    <p class="mb-0 ms-3 fs-9 text-body border-bottom-0">No staff on leave today</p>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
            <div class="col-auto d-flex">
              <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
            </div>
            <div class="col-auto d-flex">
              <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
              <ul class="mb-0 pagination"></ul>
              <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
            </div>
          </div>

        </div>

        <div id="week-on-leave" class="leave-section" data-list='{"valueNames":["staff","type","startdate","returndate"],"page":4,"pagination":true}'>

          <div class="row align-items-end justify-content-between pb-4 g-3">

            <div class="col-12">
              <h3>Staff on leave this week</h3>
              <p class="text-body-tertiary lh-sm mb-0">Employees absent today, leave granted.</p>
            </div>

            <div class="col-12 col-md-auto">
              <div class="search-box px-lg-0 pe-4">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                  <input class="form-control search-input search form-control-sm" type="search" placeholder="Search leave approval" aria-label="Search" />
                  <span class="fas fa-search search-box-icon"></span>
                </form>
              </div>
            </div>

          </div>

          <div class="table-responsive ms-n1 ps-1 scrollbar h-100">
            <table class="table fs-9 mb-0 border-top border-translucent">
              <thead>
                <tr>
                  <th class="sort white-space-nowrap align-middle text-start" scope="col" data-sort="staff" style="width:auto;">STAFF</th>
                  <th class="sort align-middle text-start" scope="col" data-sort="type" style="width:auto;">TYPE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="startdate" style="width:auto;">START DATE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="returndate" style="width:auto;">RETURN DATE</th>
                </tr>
              </thead>
              <tbody class="list" id="project-summary-table-body">
                <% if(weekLeaves && weekLeaves.length>0){ %>
                <% weekLeaves.forEach(onLeave => { %>

                <tr class="position-static">

                  <td class="align-middle text-body white-space-nowrap ps-0 staff">
                    <% const staffWeek = allUser.find(staff => staff._id.toString() === onLeave.user.toString()); %>
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/staff/details/<%= onLeave.user %>"><%= staffWeek.fullname %></a>
                  </td>


                  <td class="align-middle text-body white-space-nowrap ps-0 type">
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/leave/details/<%= onLeave._id %>"><%= onLeave.type %></a>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 startdate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.start) %></p>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 returndate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.return) %></p>
                  </td>
                </tr>
                <% }); %>
                <% }else { %>
                <tr class="position-static">
                  <td class="align-middle text-body white-space-nowrap">
                    <p class="mb-0 ms-3 fs-9">No staff on leave today</p>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
            <div class="col-auto d-flex">
              <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
            </div>
            <div class="col-auto d-flex">
              <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
              <ul class="mb-0 pagination"></ul>
              <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
            </div>
          </div>

        </div>

        <div id="month-on-leave" class="leave-section" data-list='{"valueNames":["staff","type","startdate","returndate"],"page":4,"pagination":true}'>

          <div class="row align-items-end justify-content-between pb-4 g-3">

            <div class="col-12">
              <h3>Staff on leave this month</h3>
              <p class="text-body-tertiary lh-sm mb-0">Employees absent today, leave granted.</p>
            </div>

            <div class="col-12 col-md-auto">
              <div class="search-box px-lg-0 pe-4">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                  <input class="form-control search-input search form-control-sm" type="search" placeholder="Search leave approval" aria-label="Search" />
                  <span class="fas fa-search search-box-icon"></span>
                </form>
              </div>
            </div>

          </div>

          <div class="table-responsive ms-n1 ps-1 scrollbar h-100">
            <table class="table fs-9 mb-0 border-top border-translucent">
              <thead>
                <tr>
                  <th class="sort white-space-nowrap align-middle text-start" scope="col" data-sort="staff" style="width:auto;">STAFF</th>
                  <th class="sort align-middle text-start" scope="col" data-sort="type" style="width:auto;">TYPE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="startdate" style="width:auto;">START DATE</th>
                  <th class="sort align-middle text-center" scope="col" data-sort="returndate" style="width:auto;">RETURN DATE</th>
                </tr>
              </thead>
              <tbody class="list" id="project-summary-table-body">
                <% if(monthLeaves && monthLeaves.length>0){ %>
                <% monthLeaves.forEach(onLeave => { %>

                <tr class="position-static">

                  <td class="align-middle text-body white-space-nowrap ps-0 staff">
                    <% const staffMonth = allUser.find(staff => staff._id.toString() === onLeave.user.toString());%>
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/staff/details/<%= onLeave.user %>"><%= staffMonth.fullname %></a>
                  </td>


                  <td class="align-middle text-body white-space-nowrap ps-0 type">
                    <a class="mb-0 fw-bold fs-8 ps-2" href="/leave/details/<%= onLeave._id %>"><%= onLeave.type %></a>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 startdate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.start) %></p>
                  </td>

                  <td class="align-middle text-body white-space-nowrap ps-0 returndate">
                    <p class="mb-0 fs-9 text-center"><%= formatDate(onLeave.date.return) %></p>
                  </td>
                </tr>
                <% }); %>
                <% }else { %>
                <tr class="position-static">
                  <td class="align-middle text-body white-space-nowrap">
                    <p class="mb-0 ms-3 fs-9">No staff on leave today</p>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
            <div class="col-auto d-flex">
              <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
            </div>
            <div class="col-auto d-flex">
              <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
              <ul class="mb-0 pagination"></ul>
              <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <div class="col-12 col-xxl-6">
    <div class="card pt-3" style="min-height: 35vh;">
      <div class="card-body">
        <div class="d-flex mb-6">
          <div class="btn btn-phoenix-primary py-2 px-2 active" onclick="toggleSection('today-on-leave', this)">Today</div>
          <div class="btn btn-phoenix-primary py-2 px-2" onclick="toggleSection('week-on-leave', this)">Week</div>
          <div class="btn btn-phoenix-primary py-2 px-2" onclick="toggleSection('month-on-leave', this)">Month</div>
        </div>


        <div class="d-flex justify-content-center px-4 py-6">
          <div id="current-leave-bar-charts" style="height: 200px;width: 500px;"></div>
        </div>

        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // Set the initial state to show "Today's Leave" section and make the corresponding button active
            toggleSection('today-on-leave', document.querySelector('.btn-phoenix-primary.active'));

            updateBarCharts('<%= todayLeaves.length %>', '<%= weekLeaves.length %>', '<%= monthLeaves.length %>');
          });

          function toggleSection(sectionId, button) {
            // Hide all leave sections
            document.querySelectorAll('.leave-section').forEach(section => {
              section.style.display = 'none';
            });

            // Show the selected leave section
            document.getElementById(sectionId).style.display = 'block';

            // Remove active class from all buttons
            document.querySelectorAll('.btn-phoenix-primary').forEach(btn => {
              btn.classList.remove('active');
            });

            // Add active class to the clicked button
            button.classList.add('active');
          }

          function updateBarCharts(today, week, month) {
            const leaveBarCharts = echarts.init(document.getElementById('current-leave-bar-charts'), null, {
              devicePixelRatio: window.devicePixelRatio > 1 ? 2 : 1,
              renderer: 'canvas',
              width: 'auto',
              height: 'auto'
            });

            // Process the data and create series for bar charts
            const todayCount = today;
            const weekCount = week;
            const monthCount = month;

            const option = {
              color: theme.primary,
              tooltip: {
                trigger: 'item',
                padding: [7, 10],
                backgroundColor: getColor('bg-body', 'background-color'),
                borderColor: theme.secondary_subtle,
                textStyle: {
                  color: getColor('link-primary', 'color')
                },
                borderWidth: 1,
                transitionDuration: 0,
                axisPointer: {
                  type: 'none'
                },
                formatter: function(params) {
                  return `${params.name} (${params.value})`;
                }
              },
              xAxis: {
                type: 'category',
                data: ['Today', 'This Week', 'This Month'],
                boundaryGap: false,
                axisLine: {
                  show: true,
                  lineStyle: {
                    color: '#e3e6ed'
                  }
                },
                axisTick: {
                  show: false
                },
                axisLabel: {
                  interval: 6,
                  showMinLabel: true,
                  showMaxLabel: true,
                  color: '#949db5',
                }
              },
              yAxis: {
                show: false, // Set show to false to hide y-axis
              },
              series: [{
                name: 'Leave Count',
                type: 'bar',
                data: [todayCount, weekCount, monthCount],
                barWidth: '10px',
                showBackground: true,
                symbol: 'none',
                itemStyle: {
                  borderRadius: 10
                },
                backgroundStyle: {
                  borderRadius: 10,
                  color: theme.bg_primary_subtle,
                  opacity: 1.0
                }
              }],
              grid: {
                right: 10,
                left: 10,
                bottom: 0,
                top: 0
              }
            };

            // Set the option and render the chart
            leaveBarCharts.setOption(option);

            window.addEventListener('resize', function() {
              leaveBarCharts.resize();
            });
          }
        </script>
      </div>
    </div>
  </div>
</div>

<!-- toast alert submission -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
  <div class="d-flex">
    <div class="toast <%= show %> align-items-center text-white border-0" role="alert" data-bs-autohide="false" aria-live="assertive" aria-atomic="true">
      <div class="d-flex justify-content-between">
        <div class="toast-body px-0 py-3">
          <code class="text-primary"><%= alert %></code>
        </div>

        <button class="btn ms-2 p-0" type="button" data-bs-dismiss="toast" aria-label="Close">
          <span class="uil uil-times fs-7"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- alert toast upload -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
  <div class="d-flex">
    <div class="toast align-items-center text-white border-0" role="alert" data-bs-autohide="false" aria-live="assertive" aria-atomic="true" id="alertUploadToast">
      <div class="d-flex justify-content-between">
        <div class="toast-body px-0 py-3">
          <code id="dropzoneAlertContent" class="text-primary"></code>
        </div>

        <button class="btn ms-2 p-0" type="button" data-bs-dismiss="toast" aria-label="Close">
          <span class="uil uil-times fs-7"></span>
        </button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/private-footer.ejs') %>