<%- include('partials/private-header.ejs') %>

<!-- function for EJS -->
<%
  function formatCustomDate(dateString) {
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    const date = new Date(dateString);

    if (isNaN(date.getTime())) {
      return 'Invalid date';
    }

    const month = months[date.getMonth()];
    const day = date.getDate();
    const year = date.getFullYear();

    let hours = date.getHours();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // Handle midnight (0:00)

    const minutes = String(date.getMinutes()).padStart(2, '0');

    return `${month} ${day}, ${year}, ${hours}:${minutes}${ampm}`;
  }

  var showApproval = '';

  if (approvals && approvals.length > 0) {
    const userApprovalExists = approvals.some(approval => approval.recipient.equals(user._id));
    const isUserLeaveOwner = user.username === leave.username;

    if (userApprovalExists && !isUserLeaveOwner) {
        showApproval = '';
    } else if (isUserLeaveOwner) {
        showApproval = 'd-none';
    } else {
        showApproval = 'd-none';
    }
  }
%>

<nav class="mb-2" aria-label="breadcrumb">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="#!">Leave</a></li>
    <li class="breadcrumb-item"><a href="#!">Details</a></li>
    <li class="breadcrumb-item active" aria-current="page"><%= leave.uuid %></li>
  </ol>
</nav>

<div class="row d-flex flex-wrap justify-content-between align-items-end mb-2">
  <div class="col-auto">
    <h2>Request #<%= user.username %> Status (<span><%= leave.status %></span>)</h2>
    <p class="text-body-secondary mb-0">Leave request on <br class="d-sm-none"><span class="ms-sm-1"><%= formatCustomDate(leave.timestamp) %></span></p>
  </div>

  <div class="col-auto">
    <a class="btn btn-primary me-2" role="button" href="/leave/approved/<%= leave.uuid %>">Approve</a>
    <a class="btn btn-outline-danger me-2" role="button" href="/leave/denied/<%= leave.uuid %>">Deny</a>
  </div>
</div>

<div class="row gy-5 gx-5 mb-3">
  <div class="col-12 col-lg-6">
    <div class="border rounded-3 overflow-hidden h-100">
      <div class="min-vh-50 p-3">
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="timeline-vertical">
      <% if (approvals && approvals.length > 0) { %>
      <% const length = approvals.length %>
      <% approvals.forEach((approval, index) => { %>

      <% 
      var date = '';
      var time = '';
      var icon = '';
      var colour = '';
      var border = '';
      var display = ''

      if(approval.estimated === null){
        date = new Date(approval.timestamp).toLocaleDateString('en-UK', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric', 
          timeZone: 'Asia/Kuala_Lumpur' 
        });

        time = new Date(approval.timestamp).toLocaleTimeString('en-UK', {
            hour: 'numeric',
            minute: 'numeric',
            hour12: true,
            timeZone: 'Asia/Kuala_Lumpur'
        });
      }else{
        date = 'Estimated';
        time = new Date(approval.estimated).toLocaleDateString('en-UK', { 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric', 
          timeZone: 'Asia/Kuala_Lumpur' 
        });

       }

        if(approval.status === 'submitted' || approval.status === 'approved'){
            colour = 'success';
            border = 'success';
            icon = 'fa-solid fa-check';
        }else if( approval.status === 'denied'){
            colour = 'danger';
            border = 'danger';
            icon = 'fa-solid fa-xmark';
        }else if(approval.status === 'pending'){
            colour = 'warning';
            border = 'dashed';
            icon = 'fa-regular fa-hourglass-half';
        }

        if(length === index + 1){
            display = 'd-none'
        } else {
            display = '';
        }
      %>
      <div class="timeline-item">
        <div class="row g-md-3 align-items-center mb-3 mb-lg-10">
          <div class="col-12 col-md-auto d-flex">
            <div class="timeline-item-date text-end order-1 order-md-0 me-md-4 mt-md-0 mt-1">
              <p class="fs-10 fw-semibold text-body-tertiary mb-0"><%= date %><br class="d-none d-md-block"> <%= time %></p>
            </div>
            <div class="timeline-item-bar position-relative me-3 me-md-0 mb-md-0 mb-md-3 mb-3">
              <div class="icon-item icon-item-sm bg-<%= colour %>" data-bs-theme="light"><span class="<%= icon %> text-white fs-10"></span></div><span class="timeline-bar border-end border-<%= border %> <%= display %>"></span>
            </div>
          </div>
          <div class="col">
            <div class="timeline-item-content ps-6 ps-md-3">
              <h4><%= approval.role %></h4>
              <p class="fs-9 text-body-secondary mb-0"><%= approval.comment %></p>
            </div>
          </div>
        </div>
      </div>
      <% }); %>
      <% } else { %>
      <p>No approvals available</p>
      <% } %>
    </div>
  </div>
</div>

<%
function formatDate(timestamp) {
  const dateObject = new Date(timestamp);
  return dateObject.toLocaleDateString('en-UK', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    timeZone: 'Asia/Kuala_Lumpur' 
  });
}
%>

<div class="row mb-6 min-vh-50 bg-dark-subtle">

  <div class="col-12 col-lg-6 p-5">
    <div class="container border-start-0 border-bottom border-top-0 border-end-0 border-end-md border-md-0 border-dashed h-100 overflow-y-auto scrollbar-overlay">
      <h3 class="mb-3">Upcoming Leaves</h3>

      <% upcomingLeaves.forEach(upcomingLeave => { %>
      <p><strong><%= upcomingLeave.fullname %></strong>: <%= formatDate(upcomingLeave.date.start) %> until <%= formatDate(upcomingLeave.date.return) %>, <%= upcomingLeave.status  %> </p>
      <% }); %>
    </div>
  </div>

  <div class="col-12 col-lg-6 p-5">
    <div class="container h-100">
      <h3 class="mb-3">Colleague Leaves</h3>

      <% colleagueLeaves.forEach(colleagueLeave => { %>
      <p><strong><%= colleagueLeave.fullname %></strong>: <%= formatDate(colleagueLeave.date.start) %> until <%= formatDate(colleagueLeave.date.return) %>, <%= colleagueLeave.status %> </p>
      <% }); %>
    </div>
  </div>
</div>


<div class="modal fade" id="leaveApproval" tabindex="-1" aria-labelledby="leaveApproval" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-md">
    <div class="modal-content">
      <div class="modal-header border-bottom-0">
        <h1 class="modal-title fs-6" id="leaveApproval">Leave Approval</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      </div>
      <div class="modal-footer border-top-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
<%- include('partials/private-footer.ejs') %>