<%- include('partials/private-header.ejs') %>

<nav class="mb-2" aria-label="breadcrumb">
  <ol class="breadcrumb mb-0">
    <li class="breadcrumb-item"><a href="#!">Profile</a></li>
    <li class="breadcrumb-item active" aria-current="page"><%= user.username %></li>
  </ol>
</nav>
<div class="row align-items-center justify-content-between g-3 mb-4">
  <div class="col-auto">
    <h2 class="mb-0">Profile</h2>
  </div>
  <div class="col-auto">
    <div class="row g-2 g-sm-3">
      <div class="col-auto d-none">
        <button class="btn btn-phoenix-primary"><span class="fa-regular fa-envelope me-2"></span>Message</button>
      </div>
      <div class="col-auto d-none">
        <button class="btn btn-phoenix-secondary"><span class="fa-solid fa-gears me-2"></span>Settings</button>
      </div>
    </div>
  </div>
</div>
<div class="row g-3 mb-6">
  <div class="col-12 col-lg-8">
    <div class="card h-100">
      <div class="card-body">
        <div class="border-bottom border-dashed pb-4">
          <div class="row align-items-center g-3 g-sm-5 text-center text-sm-start">
            <div class="col-12 col-sm-auto">
              <input class="d-none" id="avatarFile" type="file" />
              <label class="cursor-pointer avatar avatar-5xl" for="avatarFile"><img class="rounded-circle" src="/assets/img/team/avatar.webp" alt="" style="border: 1px solid #3874ff;" /></label>
            </div>
            <% 
            const timestamp = user.dateEmployed; // Replace with your timestamp variable
            const date = new Date(timestamp + 8 * 60 * 60 * 1000); // Adjust to Malaysian Standard Time (UTC+8)
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            const formattedDate = date.toLocaleDateString(date, options);
            %>
            <div class="col-12 col-sm-auto flex-1">
              <h3><%= user.fullname %></h3>
              <p class="text-body-secondary">Joined since, <%= formattedDate  %></p>
              <div><a class="me-2" href="#!"><span class="fab fa-linkedin-in text-body-quaternary text-opacity-75 text-primary-hover"></span></a><a class="me-2" href="#!"><span class="fab fa-facebook text-body-quaternary text-opacity-75 text-primary-hover"></span></a><a href="#!"><span class="fab fa-twitter text-body-quaternary text-opacity-75 text-primary-hover"></span></a></div>
            </div>
          </div>
        </div>
        <div class="d-flex flex-between-center pt-4">
          <div>
            <h6 class="mb-2 text-body-secondary">Grade</h6>
            <h4 class="fs-7 text-body-highlight mb-0"><%= user.grade %></h4>
          </div>
          <div>
            <h6 class="mb-2 text-body-secondary">Position</h6>
            <h4 class="fs-7 text-body-highlight mb-0"><%= user.position %></h4>
          </div>
          <div>
            <h6 class="mb-2 text-body-secondary">Work ID</h6>
            <h4 class="fs-7 text-body-highlight mb-0"><%= user.username %></h4>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card h-100">
      <div class="card-body">
        <div class="border-bottom border-dashed">
          <h4 class="mb-3">Details
            <button class="btn btn-link p-0" type="button"><span class="fas fa-edit fs-9 ms-3 text-body-quaternary"></span></button>
          </h4>
        </div>
        <div class="pt-4 mb-7 mb-lg-4 mb-xl-7">
          <div class="row justify-content-between">
            <div class="col-auto">
              <h5 class="text-body-highlight">Department</h5>
            </div>
            <div class="col-auto">
              <p class="text-body-secondary"><%= user.department %><br /><%=  user.section %></p>
            </div>
          </div>
        </div>
        <div class="border-top border-dashed pt-4">
          <div class="row flex-between-center mb-2">
            <div class="col-auto">
              <h5 class="text-body-highlight mb-0">Email</h5>
            </div>
            <div class="col-auto"><a class="lh-1" href="mailto:<%= user.email %>"><%= user.email %></a></div>
          </div>
          <div class="row flex-between-center">
            <div class="col-auto">
              <h5 class="text-body-highlight mb-0">Phone</h5>
            </div>
            <div class="col-auto"><a href="tel:+6<%= user.phone %>">+6<%= user.phone %></a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="mb-6">
  <div class="scrollbar">
    <ul class="nav nav-underline fs-9 flex-nowrap mb-3 pb-1" id="myTab" role="tablist">
      <li class="nav-item me-3"><a class="nav-link text-nowrap active" id="orders-tab" data-bs-toggle="tab" href="#tab-activity" role="tab" aria-controls="tab-orders" aria-selected="true"><span class="fa-solid fa-clock me-2"></span>Activity<span class="text-body-tertiary fw-normal"> (<%= activities.length %>)</span></a></li>
      <li class="nav-item me-3"><a class="nav-link text-nowrap" id="reviews-tab" data-bs-toggle="tab" href="#tab-leave" role="tab" aria-controls="tab-orders" aria-selected="true"><span class="fa-solid fa-calendar me-2"></span>Leave<span class="text-body-tertiary fw-normal"></span></a></li>
      <li class="nav-item me-3"><a class="nav-link text-nowrap" id="wishlist-tab" data-bs-toggle="tab" href="#tab-personal" role="tab" aria-controls="tab-orders" aria-selected="true"><span class="fa-solid fa-user me-2"></span>Personal</a></li>
    </ul>
  </div>
  <div class="tab-content" id="profileTabContent">
    <div class="tab-pane fade show active" id="tab-activity" role="tabpanel" aria-labelledby="activity-tab">
      <div class="border-bottom border-translucent" data-list='{"valueNames":["title","type","description","date","time"],"page":5,"pagination":true}'>
        <div class="d-md-flex justify-content-between align-items-center mb-4">
          <div class="col-12 col-md-auto">
            <div class="search-box">
              <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                <input class="form-control search-input search form-control-sm" type="search" placeholder="Search activities" aria-label="Search" />
                <span class="fas fa-search search-box-icon"></span>

              </form>
            </div>
          </div>
        </div>

        <div class="table-responsive scrollbar mx-n1 px-1 border-top">
          <table class="table fs-9 mb-0">
            <thead>
              <tr>
                <th class="sort white-space-nowrap align-middle pe-3 ps-0 text-uppercase" scope="col" data-sort="title" style="width:25%;min-width: 125px;">Title</th>
                <th class="sort align-middle ps-0 text-start text-uppercase" scope="col" data-sort="type" style="width:15%;min-width: 125px;">Type</th>
                <th class="sort align-middle pe-6 text-uppercase text-start" scope="col" data-sort="description" style="width:35%;min-width: 200px; ">Description</th>
                <th class="sort align-middle ps-0 text-center text-uppercase" scope="col" data-sort="date" style="width:15%;min-width: 100px;">Date</th>
                <th class="sort align-middle ps-0 text-center text-uppercase" scope="col" data-sort="time" style="width:15%;min-width: 100px;">Time</th>
                <th class="sort align-middle text-end" scope="col" style="width: 10%"></th>
              </tr>
            </thead>
            <tbody class="list">
              <% if(activities && activities.length > 0){ %>
              <% activities.forEach(item => { %>
              <tr class="position-static">
                <td class="title align-middle white-space-nowrap py-4 ps-0 fw-bold text-primary fs-8"><%= item.title %></td>
                <td class="type align-middle fw-semibold text-start py-2 ps-0 fs-8 text-body-highlight"><%= item.type %></td>
                <td class="description align-middle text-start fw-semibold py-2 text-start ps-2 fst-italic fs-9 text-body-highlight"><%= item.description%></td>
                <td class="date align-middle text-center py-2 ps-0 fs-9"><%= item.date.toLocaleDateString('en-UK', { day: '2-digit', month: 'short', year: 'numeric', timeZone : 'Asia/Kuala_Lumpur' }) %></td>
                <td class="time align-middle text-center py-2 ps-0 fs-9"><%= item.date.toLocaleTimeString('en-UK', { hour: '2-digit', minute: '2-digit', hour12: true, timeZone : 'Asia/Kuala_Lumpur' }) %></td>
                <td class="align-middle text-end white-space-nowrap ps-0 action">
                  <div class="font-sans-serif btn-reveal-trigger position-static">
                    <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs--2" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
                      <span class="fas fa-ellipsis-h fs-9"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end py-2">
                      <a class="dropdown-item" href="/">View</a>
                    </div>
                  </div>
                </td>
              </tr>
              <% }); %>
              <% }else{ %>
              <tr class="position-static">
                <td class="align-middle white-space-nowrap border-bottom-0">
                  <p>No activity detected from <span class="fw-bold text-primary"><%= user.fullname %></span></p>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="row align-items-center justify-content-between py-2 pe-0 fs-9">
          <div class="col-auto d-flex">
            <p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p><a class="fw-semibold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
          </div>
          <div class="col-auto d-flex">
            <button class="page-link" data-list-pagination="prev"><span class="fas fa-chevron-left"></span></button>
            <ul class="mb-0 pagination"></ul>
            <button class="page-link pe-0" data-list-pagination="next"><span class="fas fa-chevron-right"></span></button>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-pane fade" id="tab-leave" role="tabpanel" aria-labelledby="leaves-tab">
      <div data-list='{"valueNames":["type","startdate","returndate","reliefstaff","status"],"page":6,"pagination":true}'>
        <div class="d-md-flex justify-content-between align-items-center mb-4">
          <div class="col-12 col-md-auto">
            <div class="search-box">
              <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                <input class="form-control search-input search form-control-sm" type="search" placeholder="Search leave" aria-label="Search" />
                <span class="fas fa-search search-box-icon"></span>

              </form>
            </div>
          </div>
        </div>
        <div class="table-responsive scrollbar">
          <table class="table fs-9 mb-0 border-top border-200">
            <thead>
              <tr>
                <th class="sort white-space-nowrap align-middle ps-0" scope="col" data-sort="type" style="width:15%;">
                  TYPE
                </th>
                <th class="sort align-middle ps-3" scope="col" data-sort="reliefstaff" style="width:15%;">
                  RELIEF STAFF
                </th>
                <th class="sort align-middle text-center ps-3" scope="col" data-sort="startdate" style="width:15%;">
                  START DATE
                </th>
                <th class="sort align-middle text-center ps-3" scope="col" data-sort="returndate" style="width:15%;">
                  RETURN DATE
                </th>
                <th class="sort align-middle text-center" scope="col" data-sort="status" style="width:10%;">
                  STATUS
                </th>
                <th class="sort align-middle text-end" scope="col" style="width: 5%"></th>
              </tr>
            </thead>

            <% 
                    function formatDate(inputDate) {
                      const day = String(inputDate.getDate()).padStart(2, '0');
                      const month = String(inputDate.getMonth() + 1).padStart(2, '0');
                      const year = inputDate.getFullYear();
                    
                      return `${day}/${month}/${year}`;
                    }
                    %>

            <!-- table content -->
            <tbody class="list">
              <% if (leave && leave.length>0) { %>
              <!-- table item -->
              <% leave.forEach(function(leaves) { %>

              <% 
                      var statusColor = '';
                      if (leaves.status == "pending"){
                          statusColor = 'info';
                      } else if(leaves.status == "approved" || leaves.status == "submitted") {
                          statusColor = 'success';
                      } else if(leaves.status == "denied" ||  leaves.status == "cancelled") {
                          statusColor = 'danger';
                      }else if (leaves.status == "invalid"){
                          statusColor = 'warning';
                      } 

                  %>
              <tr class="position-static">
                <td class="align-middle time white-space-nowrap ps-0 type py-4">
                  <a class="fw-bold fs-8" href="/leave/details/<%= leaves._id %>"><%= leaves.type %></a>
                </td>
                <td class="align-middle text-body white-space-nowrap reliefstaff ps-3">
                  <% 
                        const checkUserRelief = allUser.find(check => check._id.toString() === leaves.assignee[0].toString());
                      %>
                  <a class="mb-0 fs-9" href="/staff/details/<%= checkUserRelief._id %>"><%= checkUserRelief.fullname %></a>
                </td>
                <td class="align-middle white-space-nowrap startdate text-center ps-3 py-4">
                  <p class="mb-0 fs-9 text-body"><%= formatDate(leaves.date.start) %></p>
                </td>
                <td class="align-middle white-space-nowrap returndate text-center ps-3 py-4">
                  <p class="mb-0 fs-9 text-body"><%= formatDate(leaves.date.return) %></p>
                </td>
                <td class="align-middle white-space-nowrap text-center status">
                  <span class="badge badge-phoenix fs-10 badge-phoenix-<%= statusColor %>"><%= leaves.status %></span>
                </td>
                <td class="align-middle text-end white-space-nowrap pe-0 action">
                  <div class="font-sans-serif btn-reveal-trigger position-static">
                    <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal fs--2" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
                      <span class="fas fa-ellipsis-h fs-9"></span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end py-2">
                      <a class="dropdown-item" href="/leave/details/<%= leaves.uuid %>">View</a>
                    </div>
                  </div>
                </td>
              </tr>
              <%  }); %> <% } else { %>
              <tr class="position-static">
                <td class="align-middle time white-space-nowrap ps-0 border-bottom-0">
                  <p>No leave submitted from <span class="fw-bold text-primary"><%= user.fullname %></span></p>
                </td>
              </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        <div class="d-flex flex-wrap align-items-center justify-content-between py-3 pe-0 fs-9 border-bottom border-200">
          <div class="d-flex">
            <p class="mb-0 d-none d-sm-block me-3 fw-semi-bold text-900" data-list-info="data-list-info"></p>
            <a class="fw-semi-bold" href="#!" data-list-view="*">View all<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semi-bold d-none" href="#!" data-list-view="less">View Less<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a>
          </div>
          <div class="d-flex">
            <button class="page-link" data-list-pagination="prev">
              <span class="fas fa-chevron-left"></span>
            </button>
            <ul class="mb-0 pagination"></ul>
            <button class="page-link pe-0" data-list-pagination="next">
              <span class="fas fa-chevron-right"></span>
            </button>
          </div>
        </div>
      </div>

    </div>

    <div class="tab-pane fade" id="tab-personal" role="tabpanel" aria-labelledby="personal-tab">
      <div class="row g-3 mb-6">

        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-id-card-clip"></i></span>
            <div class="form-floating">
              <input type="text" class="form-control" id="floatingInputGroup1" placeholder="" value="<%= user.nric %>" disabled>
              <label for="floatingInputGroup1">NRIC</label>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-cake-candles"></i></span>
            <div class="form-floating">
              <input type="text" class="form-control" id="floatingInputGroup1" placeholder="" value="<%= user.birthday %>" disabled>
              <label for="floatingInputGroup1">Birthday</label>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-venus-mars"></i></span>
            <div class="form-floating">
              <input type="text" class="form-control" id="floatingInputGroup1" placeholder="" value="<%= user.gender %>" disabled>
              <label for="floatingInputGroup1">Gender</label>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-brands fa-pagelines"></i></span>
            <div class="form-floating">
              <input type="text" class="form-control" id="floatingInputGroup1" placeholder="" value="<%= user.age %>" disabled>
              <label for="floatingInputGroup1">Age</label>
            </div>
          </div>
        </div>

        <div class="col-md-4">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-user-graduate"></i></span>
            <div class="form-floating">
              <input type="text" class="form-control" id="floatingInputGroup1" placeholder="" value="<%= user.education %>" disabled>
              <label for="floatingInputGroup1">Education</label>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="input-group">
            <span class="input-group-text"><i class="fa-solid fa-map-pin"></i></span>
            <div class="form-floating">
              <textarea style="height: 100px; width: 100%;" class="form-control" disabled><%= user.address %></textarea>
              <label for="floatingInputGroup1">Address</label>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
<!-- end of .container-->

<%- include('partials/private-footer.ejs') %>