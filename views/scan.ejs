<%- include('partials/private-header') %>
<div class="mb-3 mt-n3">

  <section class="px-0" id="demo-content">
    <h2 class="title">QR Scanner</h2>
    <p class="mb-5">Scan, decode, interpret, retrieve data quickly.</p>

    <div class="mb-3">

    </div>

    <div class="mb-3 row g-3">


      <div class="col-12 col-md-6">
        <div class="border border-gray rounded-3 p-4 mb-3" style="min-height: 25vh;">
          <video id="video" class="w-100"></video>
        </div>
        <button class="btn btn-primary w-100 w-lg-10" id="startButton">Start</button>
      </div>

      <div class="col-12 col-md-6" id="afterScan">
        <p id="userData"></p>

        <div class="card mx-auto w-75">
          <div class="card-body text-center">
            <div class="avatar avatar-4xl mb-3 mx-auto"><img class="rounded-circle border border-primary" src="/assets/img/team/avatar.webp" alt="" /></div>
            <p class="fw-bold fs-7 mb-0">Sharir Shazni bin Sazali</p>
            <p class="fw-bold fst-italic mb-3">P781</p>
            <p class="mb-0">Finance Department</p>
            <p class="">Project and Technology</p>
          </div>
        </div>
      </div>

    </div>


  </section>

  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    function decodeOnce(codeReader, selectedDeviceId) {
      codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {

        sendScannedDataToServer(result.text);
      }).catch((err) => {
        console.error(err);
        document.getElementById('result').textContent = err;
      });
    }

    function sendScannedDataToServer(data) {
      fetch('/process-scanned-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            scannedData: data,
            id: '<%= user._id %>'
          })
        })
        .then(response => response.json()) // Parse response JSON
        .then(userResponse => {
          // Update UI with user data
          const userDataElement = document.getElementById('userData');
          if (userResponse) {
            userDataElement.textContent = `User ID: ${userResponse.user._id}, Username: ${userResponse.user.username}, Email: ${userResponse.user.email}`;
          } else {
            userDataElement.textContent = 'User not found';
          }
        })
        .catch(error => {
          console.error('Error processing scanned data:', error);
        });
    }

    window.addEventListener('load', function() {
      let codeReader;
      let selectedDeviceId;

      function startScan() {
        codeReader = new ZXing.BrowserQRCodeReader();
        console.log('ZXing code reader initialized');

        // Always decode once, no need for changing video source
        codeReader.getVideoInputDevices().then((videoInputDevices) => {
          if (videoInputDevices.length >= 1) {
            // Find the environment camera if available
            const environmentCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('environment') || device.label.toLowerCase().includes('rear'));
            if (environmentCamera) {
              selectedDeviceId = environmentCamera.deviceId;
            } else {
              selectedDeviceId = videoInputDevices[0].deviceId;
            }
            decodeOnce(codeReader, selectedDeviceId);
          }
        }).catch((err) => {
          console.error(err);
        });
      }

      document.getElementById('startButton').addEventListener('click', () => {
        if (codeReader) {
          codeReader.reset();
          document.getElementById('result').textContent = '';
          startScan();
        } else {
          startScan();
        }
      });
    });
  </script>

</div>
<%- include('partials/private-footer.ejs') %>