<%- include('partials/private-header') %>
<div class="mb-3 mt-n3">

  <section class="px-0">

    <div class="mb-5" id="title">
      <h2 class="title">QR Scanner</h2>
      <p class="mb-5">Scan, decode, interpret, retrieve data quickly.</p>
    </div>

    <div class="mb-3 row g-3">

      <div class="col-12 col-md-6 z-1" id="scanner">
        <div class="border border-gray rounded-3 p-4 mb-3" style="min-height: 25vh;">
          <video id="video" class="w-100"></video>
        </div>
        <button class="btn btn-primary w-100 w-lg-10" id="startButton">Start</button>
      </div>

      <div class="col-12 col-md-6" id="afterScan">
        <p id="userData"></p>

        <style>
          .card-container {
            perspective: 1000px;
            opacity: 0;
            z-index: 0;
            position: absolute;
            top: 2vh;
            left: 0;
            right: 0;
            bottom: 0;
            margin: auto;
          }

          .card {
            position: relative;
            transition: transform 0.8s;
            transform-style: preserve-3d;
          }

          .card.flip {
            transform: rotateY(180deg);
          }

          .front,
          .back {
            backface-visibility: hidden;
          }

          .back {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotateY(180deg);
          }

          /* Fade in animation */
          @keyframes fadeIn {
            from {
              opacity: 0;
            }

            to {
              opacity: 1;
            }
          }

          .fade-in {
            animation: fadeIn 2s ease forwards;
          }

          /* Fade out animation */
          @keyframes fadeOut {
            from {
              opacity: 1;
            }

            to {
              opacity: 0;
            }
          }

          .fade-out {
            animation: fadeOut 2s ease forwards;
          }

          @media screen and (max-width: 768px) {
            .card-container {
              margin-top: -45vh;
              position: relative;
              width: 80vw;
            }
          }
        </style>

        <div class="card-container mb-3">
          <div class="card mx-auto w-100 w-lg-50 mb-0" id="card">
            <div class="card-body text-center front">
              <div class="avatar avatar-4xl mb-3 mx-auto"><img class="rounded-circle border border-primary" src="/assets/img/team/avatar.webp" alt="" /></div>
              <p class="fw-bold fs-7 mb-0"><%= user.fullname %></p>
              <p class="fw-bold fst-italic mb-3"><%= user.username %></p>
              <p class="mb-3"><%= user.position %></p>
              <p class="mb-0"><%= user.department %></p>
              <p class=""><%= user.section %></p>
            </div>
            <div class="card-body back text-center">
              <h4 class="mb-0 mt-2" id="message"></h4>
              <div class="d-flex justify-content-center align-items-center">
                <lottie-player class="mx-auto mt-n5" src="https://lottie.host/9286c4fc-dca4-4d7f-b918-85480656a0cf/bLVZCz5laC.json" speed="1" style="width: 300px; height: 300px" loop autoplay direction="1" mode="normal"></lottie-player>
              </div>
            </div>
          </div>
        </div>

      </div>

    </div>

  </section>

  <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>

  <script>
    function decodeOnce(codeReader, selectedDeviceId) {
      codeReader.decodeFromInputVideoDevice(selectedDeviceId, 'video').then((result) => {

        sendScannedDataToServer(result.text);
      }).catch((err) => {
        console.error(err);
      });
    }

    function sendScannedDataToServer(data) {
      fetch('/process-scanned-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            scannedData: data,
            id: '<%= user._id %>'
          })
        })
        .then(response => response.json()) // Parse response JSON
        .then(userResponse => {


          const title = document.getElementById('title');
          const cardContainer = document.querySelector('.card-container');
          const scanner = document.getElementById('scanner');
          const message = document.getElementById('message');

          message.textContent = userResponse.message;
          title.classList.add('fade-out');
          scanner.classList.add('fade-out');
          cardContainer.classList.add('fade-in');
          setTimeout(() => {
            document.getElementById('card').classList.toggle('flip');
          }, 3000);

        })
        .catch(error => {
          console.error('Error processing scanned data:', error);
        });
    }

    window.addEventListener('load', function() {
      let codeReader;
      let selectedDeviceId;

      function startScan() {
        codeReader = new ZXing.BrowserQRCodeReader();
        console.log('ZXing code reader initialized');

        // Always decode once, no need for changing video source
        codeReader.getVideoInputDevices().then((videoInputDevices) => {
          if (videoInputDevices.length >= 1) {
            // Find the environment camera if available
            const environmentCamera = videoInputDevices.find(device => device.label.toLowerCase().includes('environment') || device.label.toLowerCase().includes('rear'));
            if (environmentCamera) {
              selectedDeviceId = environmentCamera.deviceId;
            } else {
              selectedDeviceId = videoInputDevices[0].deviceId;
            }
            decodeOnce(codeReader, selectedDeviceId);
          }
        }).catch((err) => {
          console.error(err);
        });
      }

      document.getElementById('startButton').addEventListener('click', () => {
        if (codeReader) {
          codeReader.reset();
          document.getElementById('result').textContent = '';
          startScan();
        } else {
          startScan();
        }
      });
    });
  </script>

</div>
<%- include('partials/private-footer.ejs') %>