<%- include("partials/private-header.ejs") %>

<script>
  // take the root of the colour from css for echarts
  const style = getComputedStyle(document.body);
  const theme = {
    primary: style.getPropertyValue('--phoenix-primary'),
    secondary: style.getPropertyValue('--phoenix-secondary'),
    success: style.getPropertyValue('--phoenix-success'),
    info: style.getPropertyValue('--phoenix-info'),
    warning: style.getPropertyValue('--phoenix-warning'),
    danger: style.getPropertyValue('--phoenix-danger'),
    bg_primary_subtle: style.getPropertyValue('--phoenix-primary-bg-subtle'),
    tertiary: style.getPropertyPriority('--phoenix-tertiary-color'),
    light: style.getPropertyValue('--phoenix-light'),
    dark: style.getPropertyValue('--phoenix-dark'),
    secondary_subtle: style.getPropertyValue('--phoenix-secondary-border-subtle'),
    cyan: style.getPropertyValue('--phoenix-cyan'),
    gray_100: style.getPropertyValue('--phoenix-gray-100'),
    card_bg: style.getPropertyValue('--phoenix-card-color')

  };

  //   take css class color based on their property color/bg-colour for echarts
  function getColor(className, property) {
    var element = document.createElement('div');
    element.className = className;
    document.body.appendChild(element);

    var computedStyle = window.getComputedStyle(element);
    var color = computedStyle.getPropertyValue(property);

    document.body.removeChild(element);

    return color;
  }
</script>

<div class="container mt-5">
  <h3 class="mb-3">Schedule Search</h3>
  <form id="schedule-form">
    <div class="row">
      <div class="col-12 col-md-3 mb-3">
        <div class="input-group">
          <input class="form-control flatpickr-input" type="text" id="selectedDate" name="date" placeholder="Select date" data-options='{"disableMobile":false,"allowInput":true, "locale" : { "firstDayOfWeek" : 1}, "mode": "single", "dateFormat": "m/Y","disable": [true]}' />
          <span class="input-group-text"><i class="fas fa-calendar"></i></span>
        </div>
      </div>
      <div class="col-12 col-md-3">
        <select class="form-select" id="floatingSelectTask" name="location" required>
          <option value="">Select Location</option>
          <option value="Baitul Makmur I">Baitul Makmur I</option>
          <option value="Baitul Makmur II">Baitul Makmur II</option>
          <option value="Jamek Mosque">Jamek Mosque</option>
          <option value="City Mosque">City Mosque</option>
          <option value="Raudhatul Sakinah">Raudhatul Sakinah</option>
        </select>
      </div>
    </div>
  </form>
  <div id="schedule-results" class="mt-4"></div>
  <div id="staff-results" class="mt-4"></div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#schedule-form');
    const selectedDateInput = document.querySelector('#selectedDate');
    const locationSelect = document.querySelector('#floatingSelectTask');

    // Initialize Flatpickr with the specified options
    flatpickr(selectedDateInput, {
      disableMobile: false,
      allowInput: true,
      locale: {
        firstDayOfWeek: 1
      },
      mode: 'single',
      dateFormat: 'm/Y',
      disable: [true] // Add specific dates to disable if needed
    });

    function fetchSchedules() {
      const formData = new FormData(form);
      const date = formData.get('date');
      const location = formData.get('location');

      if (date && location) {
        // Convert MM/YYYY to Date range
        const [month, year] = date.split('/').map(Number);
        const startDate = moment().year(year).month(month - 1).startOf('month').utcOffset(8).toDate();
        const endDate = moment().year(year).month(month - 1).endOf('month').utcOffset(8).toDate();

        const queryParams = new URLSearchParams({
          date: startDate.toISOString(),
          location: location
        }).toString();

        fetch('/search-schedule-temp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: queryParams,
          })
          .then(response => response.json())
          .then(data => {
            displaySchedules(data.schedules, data.staffDetails, year, month, location);
            displayStaffDetails(data.staffDetails, date, location);
          })
          .catch(error => {
            console.error('Fetch error:', error);
          });
      } else {
        const resultContainer = document.getElementById('schedule-results');
        const staffContainer = document.getElementById('staff-results');
        resultContainer.innerHTML = '<p>Please select both date and location.</p>';
        staffContainer.innerHTML = '';
      }
    }

    function calculateEndTime(startTime) {
      const startHour = parseInt(startTime.slice(0, 2), 10);
      const startMinute = parseInt(startTime.slice(2), 10);
      const startDate = new Date(1970, 0, 1, startHour, startMinute);
      const endDate = new Date(startDate.getTime() + 8 * 60 * 60 * 1000);
      const endHour = endDate.getHours().toString().padStart(2, '0');
      const endMinute = endDate.getMinutes().toString().padStart(2, '0');
      return `${endHour}${endMinute}`;
    }

    function displaySchedules(schedules, staffDetails, year, month, location) {
      const resultContainer = document.getElementById('schedule-results');
      resultContainer.innerHTML = '';

      const daysInMonth = moment(`${year}-${month}`, "YYYY-MM").daysInMonth();
      const firstDayOfWeek = moment(`${year}-${month}-01`).day();

      const table = document.createElement('table');
      table.className = 'table table-bordered';
      table.style.width = '100%';
      table.style.tableLayout = 'fixed';

      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const headerRow = document.createElement('tr');
      daysOfWeek.forEach(day => {
        const th = document.createElement('th');
        th.innerText = day;
        th.className = 'text-center';
        th.style.width = '14.2857142857%';
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      table.appendChild(thead);

      let currentRow = document.createElement('tr');
      for (let i = 0; i < firstDayOfWeek; i++) {
        currentRow.appendChild(document.createElement('td'));
      }

      for (let day = 1; day <= daysInMonth; day++) {
        if (currentRow.children.length === 7) {
          tbody.appendChild(currentRow);
          currentRow = document.createElement('tr');
        }
        const cell = document.createElement('td');
        cell.className = 'p-0 fs-9 fw-bold';
        cell.style.backgroundColor = '#fff';
        cell.style.height = '175px';
        cell.style.minHeight = '175px';

        const container = document.createElement('div');
        container.style.position = 'relative';

        const fullDate = moment(`${year}-${month}-${day}`).format('DD.MM.YYYY');
        const dateDiv = document.createElement('div');
        dateDiv.className = 'px-1 py-0 text-center bg-light fst-italic';
        dateDiv.style.width = '100%';
        dateDiv.innerHTML = `<strong>${fullDate}</strong>`;
        container.appendChild(dateDiv);

        const locationRow = document.createElement('div');
        locationRow.className = 'px-1 py-0 text-center bg-light notranslate';
        locationRow.style.width = '100%';
        locationRow.innerHTML = `<strong>${location}</strong>`;
        container.appendChild(locationRow);

        const innerTable = document.createElement('table');
        innerTable.className = 'table table-sm table-borderless';
        innerTable.style.width = '100%';
        innerTable.style.tableLayout = 'fixed';

        // Build a map of staff names to their indices for the current date
        const staffMap = new Map();
        staffDetails.forEach((detail, index) => {
          if (new Date(detail.date).toDateString() === new Date(`${year}-${month}-${day}`).toDateString()) {
            detail.staff.forEach(staffMember => {
              if (!staffMap.has(staffMember)) {
                staffMap.set(staffMember, index + 1);
              }
            });
          }
        });

        const schedulesForDay = schedules.filter(schedule => new Date(schedule.date).getDate() === day);

        if (schedulesForDay.length === 0) {
          const noScheduleRow = document.createElement('tr');
          const noScheduleCell = document.createElement('td');
          noScheduleCell.colSpan = 2;
          noScheduleCell.className = 'text-center text-muted my-auto';
          noScheduleCell.style.display = 'flex';
          noScheduleCell.style.alignItems = 'center';
          noScheduleCell.style.justifyContent = 'center';
          noScheduleCell.style.height = '130px';
          noScheduleCell.innerHTML = 'No schedule yet';
          noScheduleRow.appendChild(noScheduleCell);
          innerTable.appendChild(noScheduleRow);
        } else {
          schedulesForDay.forEach(schedule => {
            schedule.shift.forEach((shiftDetail, index) => {
              const row = document.createElement('tr');
              row.style.height = '30px';

              const shiftCell = document.createElement('td');
              shiftCell.className = 'p-1 py-0';
              shiftCell.style.border = '1px solid #dee2e6';
              shiftCell.style.borderLeft = 'none';
              shiftCell.style.borderRight = 'none';
              shiftCell.style.width = '10%';
              shiftCell.style.minWidth = '0';
              shiftCell.style.maxWidth = '10%';
              shiftCell.style.whiteSpace = 'nowrap';
              shiftCell.innerHTML = String.fromCharCode(65 + index);

              const staffCell = document.createElement('td');
              staffCell.style.border = '1px solid #dee2e6';
              staffCell.style.borderRight = 'none';
              staffCell.style.width = '90%';
              staffCell.style.whiteSpace = 'nowrap';

              staffCell.innerHTML = shiftDetail.staff.map(staffMember => {
                // Get the index from the staffMap
                const staffIndex = staffMap.get(staffMember);

                return `<span style="display: inline-block; border-right: 1px solid #dee2e6;" class="px-2">${staffIndex || ''}</span>`;
              }).join('');

              row.appendChild(shiftCell);
              row.appendChild(staffCell);
              innerTable.appendChild(row);
            });
          });
        }

        container.appendChild(innerTable);
        cell.appendChild(container);
        currentRow.appendChild(cell);
      }

      while (currentRow.children.length < 7) {
        currentRow.appendChild(document.createElement('td'));
      }
      tbody.appendChild(currentRow);
      table.appendChild(tbody);
      resultContainer.appendChild(table);
    }

    function displayStaffDetails(staffDetails, date, location) {
      const staffContainer = document.getElementById('staff-results');
      staffContainer.innerHTML = '';

      if (staffDetails.length > 0) {
        const header = document.createElement('h4');
        header.innerText = `Staff Details for ${location} (${date})`;
        staffContainer.appendChild(header);

        const table = document.createElement('table');
        table.className = 'table table-striped';
        const thead = document.createElement('thead');
        const tbody = document.createElement('tbody');

        const headerRow = document.createElement('tr');
        const columns = ['No.', 'Shift', 'Staff'];
        columns.forEach(col => {
          const th = document.createElement('th');
          th.innerText = col;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        staffDetails.forEach((staff, index) => {
          const row = document.createElement('tr');
          const noCell = document.createElement('td');
          noCell.innerText = index + 1;
          row.appendChild(noCell);

          const shiftCell = document.createElement('td');
          shiftCell.innerText = staff.shift;
          row.appendChild(shiftCell);

          const staffCell = document.createElement('td');
          staffCell.innerText = staff.staff.join(', ');
          row.appendChild(staffCell);

          tbody.appendChild(row);
        });

        table.appendChild(tbody);
        staffContainer.appendChild(table);
      } else {
        staffContainer.innerHTML = '<p>No staff details available for the selected date and location.</p>';
      }
    }

    form.addEventListener('change', fetchSchedules);
  });
</script>

<%- include("partials/private-footer.ejs") %>