<%- include('partials/private-header.ejs') %>

<div class="container">
  <div class="card task-list h-100">
    <div class="card-header border-bottom-0 pb-0">
      <div class="row justify-content-between align-items-center mb-4">
        <div class="col-auto">
          <h3 class="text-body-emphasis">To do</h3>
          <p class="mb-0 text-body-tertiary">Task assigned to me</p>
        </div>
        <div class="col-auto w-100 w-md-auto">
          <div class="row align-items-center g-0 justify-content-between">
            <div class="col-12 col-sm-auto">
              <div class="search-box w-100 mb-2 mb-sm-0" style="max-width:30rem;">
                <form class="position-relative" data-bs-toggle="search" data-bs-display="static">
                  <input class="form-control search-input search" id="searchInput" type="search" placeholder="Search tasks" aria-label="Search" />
                  <span class="fas fa-search search-box-icon"></span>

                </form>
              </div>
            </div>
            <div class="col-auto d-flex">
              <p class="mb-0 ms-sm-3 fs-9 text-body-tertiary fw-bold"><span class="fas fa-filter me-1 fw-extra-bold fs-10"></span><%= tasks.length %> tasks</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card-body py-0 scrollbar task-list-body" id="itemList">
      <% if(tasks && tasks.length > 0 ) {%>
      <% const lastIndexItem = tasks.length - 1; %>
      <% tasks.forEach((item,index) => { %>

      <% 
        var todoborder = '';
        var fileAmount = '';
        var displayTaskFile = '';
        var displayTaskSubtask = '';
        var statusTaskColour = '';
        const associatedFile = files.filter((file) => file.uuid === item.fileId);;

        // check last item inside task
        if(index === lastIndexItem){
            todoborder = 'border-bottom';
        }else{
            todoborder = '';
        }

        // find assc files
        if (associatedFile.length > 0) {
            fileAmount = associatedFile.length;
            displayTaskFile = 'd-block';
        } else {
            fileAmount  = '';
            displayTaskFile = 'd-none';
        }

        // check subtask
        if(item.subtask.length > 0){
            displayTaskSubtask = 'd-block';
        } else {
            displayTaskSubtask = '';
        }

        // check task status 
        if(item.status === 'urgent'){
            statusTaskColour = 'warning';
        } else if(item.status === 'process'){
            statusTaskColour = 'primary';
        } else if(item.status === 'cancelled'){
            statusTaskColour = 'danger';            
        } else if(item.status === 'done'){
            statusTaskColour = 'success';            
        } 
      %>

      <div class="item">
        <div class="d-flex hover-actions-trigger py-3 border-top <%= todoborder %>">
          <input class="form-check-input form-check-input-todolist flex-shrink-0 my-1 me-2 form-check-input-undefined" type="checkbox" id="checkbox-todo-1" data-event-propagation-prevent="data-event-propagation-prevent" />
          <div class="row justify-content-between align-items-md-center btn-reveal-trigger border-translucent gx-0 flex-1 cursor-pointer" data-bs-toggle="modal" data-bs-target="#task<%= index %>">
            <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
              <div class="mb-1 mb-md-0 d-flex align-items-center lh-1">
                <label class="form-check-label mb-1 mb-md-0 mb-xl-1 mb-xxl-0 fs-8 me-2 line-clamp-1 text-body cursor-pointer itemName"><%= item.name %></label><span class="badge badge-phoenix ms-auto fs-10 badge-phoenix-<%= statusTaskColour %> itemStatus"><%= item.status %></span>
              </div>
            </div>
            <div class="col-12 col-md-auto col-xl-12 col-xxl-auto">
              <div class="d-flex lh-1 align-items-center"><a class="text-body-tertiary fw-bold fs-10 me-2 <%= displayTaskFile %>" href="#!"><span class="fas fa-paperclip me-1"></span><%= fileAmount %></a><a class="text-warning fw-bold fs-10 me-2 <%= displayTaskSubtask %>" href="#!"><span class="fas fa-tasks me-1"></span><%= item.subtask.length %></a>
                <p class="text-body-tertiary fs-10 mb-md-0 me-2 me-md-3 me-xl-2 me-xxl-3 mb-0 itemDate"><%= item.due ? item.due.toLocaleDateString('en-UK', { day: 'numeric', month: 'short', year: 'numeric' }) : 'Not specified' %></p>
                <div class="hover-md-hide hover-xl-show hover-xxl-hide">
                  <p class="text-body-tertiary fs-10 fw-bold mb-md-0 mb-0 ps-md-3 ps-xl-0 ps-xxl-3 border-start-md border-xl-0 border-start-xxl itemTime"><%= item.reminder ? item.reminder.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true, timeZone: 'Asia/Kuala_Lumpur' }) : 'Not specified' %></p>
                </div>
              </div>
            </div>
          </div>
          <div class="d-none d-md-block d-xl-none d-xxl-block end-0 position-absolute" style="top: 23%;" data-event-propagation-prevent="data-event-propagation-prevent">
            <div class="hover-actions end-0" data-event-propagation-prevent="data-event-propagation-prevent">
              <button class="btn btn-phoenix-secondary btn-icon me-1 fs-10 text-body px-0 me-1" data-event-propagation-prevent="data-event-propagation-prevent"><span class="fas fa-edit"></span></button>
              <button class="btn btn-phoenix-secondary btn-icon fs-10 text-danger px-0" data-event-propagation-prevent="data-event-propagation-prevent"><span class="fas fa-trash"></span></button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="task<%= index %>" tabindex="<%= index %>" aria-hidden="true">
        <div class="modal-dialog modal-xl">
          <div class="modal-content bg-body overflow-hidden">
            <div class="modal-header px-6 py-5 pe-sm-5 px-md-6 dark__bg-gray-1100">
              <h3 class="text-body-highlight fw-bolder mb-0"><%= item.name %></h3>
              <button class="btn btn-phoenix-secondary btn-icon btn-icon-xl flex-shrink-0" type="button" data-bs-dismiss="modal" aria-label="Close"><span class="fa-solid fa-xmark"></span></button>
            </div>
            <div class="modal-body bg-body-highlight px-6 py-0">
              <div class="row gx-14">
                <div class="col-12 col-lg-7 border-end-lg">
                  <div class="py-6">
                    <div class="mb-7">
                      <div class="d-flex align-items-center mb-3">
                        <h4 class="text-body me-3">Description</h4><a class="btn btn-link text-decoration-none p-0" data-bs-target="#description" data-bs-toggle="modal"><span class="fa-solid fa-pen"></span></a>
                      </div>
                      <p class="text-body-highlight mb-0"><%= item.description %></p>
                    </div>

                    <%
                      const formatDateFile = (date) => {
                        const options = { day: 'numeric', month: 'short', hour: 'numeric', minute: 'numeric', hour12: true };
                        const formattedDate = new Intl.DateTimeFormat('en-US', options).format(date);
                      
                        // Add day suffix (st, nd, rd, or th)
                        const day = date.getDate();
                        const daySuffix = (day) => {
                          if (day >= 11 && day <= 13) {
                            return 'th';
                          }
                          const lastDigit = day % 10;
                          switch (lastDigit) {
                            case 1: return 'st';
                            case 2: return 'nd';
                            case 3: return 'rd';
                            default: return 'th';
                          }
                        };
                      
                        return formattedDate.replace(/(\d+)/, (match, p1) => `${p1}${daySuffix(day)}`);
                      };
                    %>



                    <div class="mb-7">
                      <h4 class="mb-3">Subtasks</h4>

                      <% if(item.subtask && item.subtask.length > 0){ %>
                      <% const lastSubtaskIndex = item.subtask.length - 1 ; %>
                      <% item.subtask.forEach((subtask,index) => { %>

                      <%
                        var subtaskBorder = '';
                        if(index === lastSubtaskIndex) {
                          subtaskBorder = 'border-bottom';
                        } else {
                          subtaskBorder = '';
                        }
                        %>
                      <div class="d-flex flex-between-center hover-actions-trigger py-3 border-top <%= subtaskBorder %> mb-3">
                        <div class="form-check mb-1 mb-md-0 d-flex align-items-center lh-1 min-h-auto">
                          <input class="subtask-checkbox form-check-input form-check-line-through mt-0 me-3" type="checkbox" id="subtaskundefined1" />
                          <label class="form-check-label mb-0 fs-8" for="subtaskundefined1"><%= subtask.name %></label>
                        </div>
                        <div class="hover-actions end-0">
                          <button class="btn btn-sm me-1 fs-10 text-body-tertiary px-0 me-3"><span class="fa-solid fa-pencil"></span></button>
                          <button class="btn btn-sm text-body-tertiary px-0"><span class="fa-solid fa-xmark fs-8"></span></button>
                        </div>
                      </div>
                      <% }); %>
                      <% }else { %>
                      <p>There is no subtask.</p>
                      <% } %>
                      <a class="fw-bold fs-9" href="#!" data-bs-target="#subtask" data-bs-toggle="modal"><span class="fas fa-plus me-1"></span>Add subtask</a>
                    </div>
                    <div class="mb-3">
                      <div>
                        <h4 class="mb-3">Files</h4>
                      </div>

                      <% const modalFiles = files.filter((file) => file.uuid === item.fileId); %>
                      <% const lastIndexFile = modalFiles.length - 1; var borderModalFile = ''; %>
                      <% if(modalFiles && modalFiles.length > 0){ %>
                      <% modalFiles.forEach((file, index) => { %>

                      <% 
                        if(index === lastIndexFile){
                            borderModalFile = 'border-bottom';
                        } else {
                            borderModalFile = '';
                        }
                      %>

                      <% if(file.type === '.png' || file.type === '.webp' || file.type === '.jpg' || file.type === '.jpeg' || file.type === '.gif' ){ %>
                      <div class="border-top <%= borderModalFile %> px-0 pt-4 pb-3">
                        <div class="me-n3">
                          <div class="d-flex flex-between-center">
                            <div class="d-flex mb-1"><span class="fa-solid fa-image me-2 text-body-tertiary fs-9"></span>
                              <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                            </div>
                            <div class="btn-reveal-trigger">
                              <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                              <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item" href="#!">Edit</a><a class="dropdown-item text-danger" href="#!">Delete</a><a class="dropdown-item" href="#!">Download</a><a class="dropdown-item" href="#!">Report abuse</a></div>
                            </div>
                          </div>
                          <div class="d-flex fs-9 text-body-tertiary mb-2 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="#!"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div><img class="rounded-2" src="<%= file.path %>" alt="" style="max-width:230px" />
                        </div>
                      </div>

                      <% }else { %>

                      <div class="border-top <%= borderModalFile %> px-0 pt-4 pb-3">
                        <div class="me-n3">
                          <div class="d-flex flex-between-center">
                            <div>
                              <div class="d-flex align-items-center mb-1"><span class="fa-solid fa-image me-2 fs-9 text-body-tertiary"></span>
                                <p class="text-body-highlight mb-0 lh-1"><%= file.name %></p>
                              </div>
                              <div class="d-flex fs-9 text-body-tertiary mb-0 flex-wrap"><span><%= file.size %></span><span class="text-body-quaternary mx-1">| </span><a href="#!"><%= file.user %> </a><span class="text-body-quaternary mx-1">| </span><span class="text-nowrap"><%= formatDateFile(file.date) %></span></div>
                            </div>
                            <div class="btn-reveal-trigger">
                              <button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent"><span class="fas fa-ellipsis-h"></span></button>
                              <div class="dropdown-menu dropdown-menu-end py-2"><a class="dropdown-item" href="#!">Edit</a><a class="dropdown-item text-danger" href="#!">Delete</a><a class="dropdown-item" href="#!">Download</a><a class="dropdown-item" href="#!">Report abuse</a></div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <% } %>
                      <% }); %>
                      <% }else { %>
                      <p>There is no file uploaded.</p>
                      <% } %>
                    </div><a class="fw-bold fs-9" href="#!" data-bs-target="#file" data-bs-toggle="modal"><span class="fas fa-plus me-1"></span>Add file(s)</a>
                  </div>
                </div>
                <div class="col-12 col-lg-5">
                  <form action="/task/update/<%= item._id %>" method="post">
                    <div class="py-6">
                      <h4 class="mb-4 text-body-emphasis">Others Information</h4>
                      <h5 class="text-body-highlight mb-2">Status</h5>
                      <select class="form-select mb-4" aria-label="Default select example" name="status">
                        <option selected="">Select</option>
                        <option value="process">Process</option>
                        <option value="done">Done</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="urgent">Urgent</option>
                      </select>
                      <h5 class="text-body-highlight mb-2">Due Date</h5>
                      <div class="flatpickr-input-container mb-4">
                        <input class="form-control datetimepicker ps-6" type="text" name="due" placeholder="Set the due date" data-options='{"disableMobile":true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                      </div>
                      <h5 class="text-body-highlight mb-2">Reminder</h5>
                      <div class="flatpickr-input-container mb-4">
                        <input class="form-control datetimepicker ps-6 w-100" type="text" name="reminder" placeholder="Set reminder" data-options='{"disableMobile":true, "enableTime": true}' /><span class="uil uil-calendar-alt flatpickr-icon text-body-tertiary"></span>
                      </div>
                      <div class="text-end mb-9 d-flex">
                        <button class="btn btn-phoenix-primary" type="submit">Update Task</button>
                        <a role="button" class="btn btn-phoenix-danger" href="#">Delete Task</a>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="description" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-body p-3">
              <form action="">
                <textarea id="description" rows="8" placeholder="Write your description here" name="description"></textarea>
              </form>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" data-bs-target="#task<%= index %>" data-bs-toggle="modal">Back to task</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="subtask" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalToggleLabel2">Modal 2</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Hide this modal and show the first with the button below.
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" data-bs-target="#task<%= index %>" data-bs-toggle="modal">Back to first</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="file" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="exampleModalToggleLabel2">Modal 2</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Hide this modal and show the first with the button below.
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" data-bs-target="#task<%= index %>" data-bs-toggle="modal">Back to first</button>
            </div>
          </div>
        </div>
      </div>

      <% }); %>
      <% } else { %>
      <p>There is not task assigned to you.</p>
      <% } %>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const searchInput = document.getElementById("searchInput");
        const items = document.getElementsByClassName("item");

        // Add event listener for the search input
        searchInput.addEventListener("input", function() {
          const keyword = searchInput.value.toLowerCase();

          // Loop through the list items and show/hide based on the keyword
          for (let i = 0; i < items.length; i++) {
            const itemName = items[i].getElementsByClassName("itemName")[0].innerText.toLowerCase();
            const itemDate = items[i].getElementsByClassName("itemDate")[0].innerText.toLowerCase();
            const itemTime = items[i].getElementsByClassName("itemTime")[0].innerText.toLowerCase();
            const itemStatus = items[i].getElementsByClassName("itemStatus")[0].innerText.toLowerCase();

            if (itemName.includes(keyword) || itemDate.includes(keyword) || itemTime.includes(keyword) || itemStatus.includes(keyword)) {
              items[i].style.display = "block";
            } else {
              items[i].style.display = "none";
            }
          }
        });
      });
    </script>

    <div class="card-footer border-0"><a class="fw-bold fs-9 mt-4" href="#!"><span class="fas fa-plus me-1"></span>Add new task</a></div>
  </div>
</div>


<%- include('partials/private-footer.ejs') %>