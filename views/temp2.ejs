<%- include('partials/private-header.ejs') %>

<h1>Search Staff</h1>

<form action="" id="reportForm">

  <div class="col-md-12 mt-0 mb-3">
    <h4 class="form-label">Shift Member For Patrol Location</h4>
    <div id="selectedNames" class="d-flex flex-wrap border border-300 rounded-3 px-2" style="min-height: 2.5rem"></div>
  </div>


  <div class="col-md-12 mt-0">
    <div class="row">
      <div class="col-6">
        <label class="form-label" for="validationCustom03">Search Staff Name</label>
        <input type="text" name="query" id="queryInput" class="form-control" placeholder="Search and click staff name" />
        <div class="invalid-feedback">
          Please search and click staff assigned.
        </div>
        <div class="valid-feedback">Looks good!</div>
      </div>

      <div id="results" class="mt-3 mb-3 col-12"></div>
    </div>
  </div>

  <input type="hidden" id="selectedNamesInput" name="selectedNames" value="<%= Array.isArray(selectedNames) ? selectedNames.join(',') : '' %>" />

</form>

<script>
  $(document).ready(function() {
    const queryInput = $('#queryInput');
    const selectedNamesDiv = $('#selectedNames');
    const reportIdInput = $('#reportIdInput');
    const displayNamesContainer = $('#displayNamesContainer');
    const selectedNames = [];

    $('#reportForm input[name="query"]').on('input', function() {
      const query = $(this).val();
      if (query.trim() !== '') {
        $.ajax({
          url: `/search/task/assignee?query=${query}`,
          method: 'GET',
          success: function(results) {
            displayResults(results);
          },
          error: function(error) {
            console.error(error);
          }
        });
      } else {
        // Clear results if the search query is empty
        displayResults([]);
      }
    });

    function displayResults(results) {
      const resultsDiv = $('#results');
      resultsDiv.empty();

      if (results.length === 0) {
        resultsDiv.append('<p class="text-muted">No results found</p>');
      } else {
        results.forEach(result => {
          const resultDiv = $(
            '<div class="result btn btn-outline-primary mr-2 mb-2"></div>'
          ).text(result.fullname);
          resultsDiv.append(resultDiv);

          // Add click event to handle adding and removing names
          resultDiv.click(function() {
            const clickedName = result.fullname;

            // Check if the name is already selected
            const index = selectedNames.indexOf(clickedName);
            if (index === -1) {
              // If not selected, add it to the array and update the display
              selectedNames.push(clickedName);
              updateSelectedNamesDisplay();
            } else {
              // If already selected, remove it from the array and update the display
              selectedNames.splice(index, 1);
              updateSelectedNamesDisplay();
            }
          });
        });
      }
    }

    function updateSelectedNamesDisplay() {
      // Update the display with the selected names
      selectedNamesDiv.empty();
      selectedNames.forEach(name => {
        const nameDiv = $(
          '<div class="selectedName btn btn-outline-secondary mr-2 mb-1 mt-1"></div>'
        ).text(name);
        selectedNamesDiv.append(nameDiv);

        // Add click event to remove the name
        nameDiv.click(function() {
          const removedName = $(this).text();
          const index = selectedNames.indexOf(removedName);
          selectedNames.splice(index, 1);
          updateSelectedNamesDisplay();
        });
      });

      // Update the hidden input value with selected names
      $('#selectedNamesInput').val(selectedNames.join(','));
    }
  });
</script>

<%- include('partials/private-footer.ejs') %>