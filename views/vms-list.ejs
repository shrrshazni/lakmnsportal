<%- include('partials/private-header') %>

<div class="mb-6">
    <div class="welcome_noti">
        <div class="noti_content">
            <h2>Welcome to the Visitor Management System!</h2>
            <p>We hope you have a great experience managing visitor entries and exits.</p>
        </div>
    </div>
    <div class="container">
        <div class="visitors_info">
            <h2 style="text-align: left;">Visitors Info</h2>
            <p>The total visitors who are currently on the premises.</p>
            <div class="visitors_card">
                <!-- <div class="card">
                    <div class="card-body"></div>
                </div> -->
                <div class="total_visitors">
                    <p class="count" data-type="total_visitors">
                        <span class="number"><%= totalVisitorsToday %></span>
                        Total Visitors Today
                    </p>
                </div>
                <div class="timein_visitors">
                    <p class="count" data-type="timein_visitors">
                        <span class="number"><%= timeInVisitorsToday %></span>
                        Visitors Time In Today
                    </p>
                </div>
                <div class="timeout_visitors">
                    <p class="count" data-type="timeout_visitors">
                        <span class="number"><%= timeOutVisitorsToday %></span>
                        Visitors Time Out Today
                    </p>
                </div>
            </div>
        </div>
        <!-- search visitor name, datepicker on the list -->
        <div class="visitors_list">
            <h2 style="text-align: left;">Visitors Lists</h2>
            <p>The visitor list table in real-time updates, featuring a complete set of data on individuals currently visiting.</p>
            <div class="filters">
                <!-- search visitor name -->
                <input type="text" id="search-input" placeholder="Search visitors">
                <!-- visitor status -->
                <select id="statusFilter" name="statusFilter">
                    <option value="">All Status</option>
                    <option value="checked_in">Checked-In</option>
                    <option value="checked_out">Checked-Out</option>
                </select>
                <!-- building location -->
                <select id="buildLoc" name="buildLoc">
                    <option value="">All Buildings</option>
                    <option value="baitulmakmur 1">BaitulMakmur 1</option>
                    <option value="baitulmakmur 2">BaitulMakmur 2</option>
                </select>
                <!-- datepicker -->
                <div class="date">
                    <input type="date" id="dateFilter" name="dateFilter">
                </div>
            </div>
        </div>
        <table class="visitors_table">
            <thead>
                <tr>
                    <th>No</th>
                    <th>Visitors Name</th>
                    <th>IC Number</th>
                    <th>Address</th>
                    <th>Level</th>
                    <th>No Pas</th>
                    <th>Phone Number</th>
                    <th>Purpose of Visit</th>
                    <th>Status</th>
                    <th>Time In</th>
                    <th>Time Out</th>
                    <th>Building Location</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="visitorTableBody">
                <% if (visitors.length > 0) { %>
                    <% visitors.forEach((visitor, index) => { %>
                        <tr>
                            <td><%= index + 1 %></td>
                            <td><a href="#" class="visitor-link" data-visitor='<%= JSON.stringify(visitor) %>'><%= visitor.vis_firstname %> <%= visitor.vis_lastname %></a></td>
                            <td><%= visitor.no_ic %></td>
                            <td><%= visitor.address %></td>
                            <td><%= visitor.level %></td>
                            <td><%= visitor.no_pas %></td>
                            <td><%= visitor.no_telephone %></td>
                            <td><%= visitor.pur_visit %></td>
                            <td><span class="<%= visitor.time_out ? 'status_checked_out' : 'status_checked_in' %>">
                                <%= visitor.time_out ? 'Checked-Out' : 'Checked-In' %>
                            </span></td>
                            <td><%= visitor.time_in %></td>
                            <td><%= visitor.time_out ? visitor.time_out : '-' %></td>
                            <td><%= visitor.build_loc %></td>
                            <td>
                                <% if (!visitor.time_out) { %>
                                    <form action="/toggle_status" method="POST" style="display:inline;" class="toggle-form">
                                        <input type="hidden" name="visitor_id" value="<%= visitor._id %>">
                                        <button type="submit" class="timeout_button">Time Out</button>
                                    </form>
                                <% } %>
                                <form action="/delete_visitor" method="POST" style="display:inline;" class="delete-form">
                                    <input type="hidden" name="visitor_id" value="<%= visitor._id %>">
                                    <button type="submit" class="delete_button">Delete</button>
                                </form>
                            </td>
                        </tr>
                    <% }) %>
                <% } else { %>
                    <tr>
                        <td colspan="12" style="text-align:center;">There is no visitor list found</td>
                    </tr>
                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal Structure -->
<div id="visitorModal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
            <!-- <img src="../../assets/img/pb_vms/exit_icon.png" id="closeModal" class="modal-close-icon" alt="Close"> -->
                <h5 class="modal-title">Visitor Details</h5>
                <button type="button" id="close-icon" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="visitorDetails"></p>
            </div>
            <div class="modal-footer">
                <form id="modalDeleteForm" style="display:inline;">
                    <input type="hidden" id="modalVisitorId" name="visitor_id">
                    <button id="deleteUser" class="modal-button delete-button">Delete Visitor</button>
                </form>
                <div class="modal-button-group">
                    <button id="editVisitor" class="modal-button edit-button">Edit Visitor</button>
                    <button id="cancel" class="modal-button cancel-button" style="display: none;">Cancel</button>
                    <button id="saveChanges" class="modal-button save-button" style="display: none;">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        function fetchVisitors() {
            var searchName = $('#search-input').val();
            var selectedDate = $('#dateFilter').val();
            var statusFilter = $('#statusFilter').val();
            var buildLoc = $('#buildLoc').val();
            $.ajax({
                url: '/fetch_visitors',
                method: 'GET',
                data: { search_name: searchName, selected_date: selectedDate, status_filter: statusFilter, build_loc: buildLoc },
                success: function(data) {
                    if (data.length === 0) {
                        $('#visitorTableBody').html('<tr><td colspan="12" style="text-align:center;">There is no visitor list found</td></tr>');
                    } else {
                        var rows = data.map(function(visitor, index) {
                            return `<tr>
                                <td>${index + 1}</td>
                                <td><a href="#" class="visitor-link" data-visitor='${JSON.stringify(visitor)}'>${visitor.vis_firstname} ${visitor.vis_lastname}</a></td>
                                <td>${visitor.no_ic}</td>
                                <td>${visitor.address}</td>
                                <td>${visitor.level}</td>
                                <td>${visitor.no_pas}</td>
                                <td>${visitor.no_telephone}</td>
                                <td>${visitor.pur_visit}</td>
                                <td><span class="${visitor.time_out ? 'status_checked_out' : 'status_checked_in'}">
                                    ${visitor.time_out ? 'Checked-Out' : 'Checked-In'}
                                </span></td>
                                <td>${moment(visitor.time_in).format('D/M/YYYY h:mm A')}</td>
                                <td>${visitor.time_out ? moment(visitor.time_out).format('D/M/YYYY h:mm A') : '-'}</td>
                                <td>${visitor.build_loc}</td>
                                <td>
                                    ${!visitor.time_out ? `
                                    <form action="/toggle_status" method="POST" style="display:inline;" class="toggle-form">
                                        <input type="hidden" name="visitor_id" value="${visitor._id}">
                                        <button type="submit" class="timeout_button">Time Out</button>
                                    </form>` : ''}
                                    <form action="/delete_visitor" method="POST" style="display:inline;" class="delete-form">
                                        <input type="hidden" name="visitor_id" value="${visitor._id}">
                                        <button type="submit" class="delete_button">Delete</button>
                                    </form>
                                </td>
                            </tr>`;
                        }).join('');
                        $('#visitorTableBody').html(rows);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching visitors:', error);
                    $('#visitorTableBody').html('<tr><td colspan="12" style="text-align:center;">Error loading data</td></tr>');
                }
            });
        }

        function updateVisitorCounts() {
            $.ajax({
                url: '/total_visitors',
                success: function(data) {
                    $('.total_visitors .number').text(data);
                }
            });
            $.ajax({
                url: '/total_timein_visitors',
                success: function(data) {
                    $('.timein_visitors .number').text(data);
                }
            });
            $.ajax({
                url: '/total_timeout_visitors',
                success: function(data) {
                    $('.timeout_visitors .number').text(data);
                }
            });
        }

        // Fetch visitors and update counts every 1 second
        setInterval(function() {
            fetchVisitors();
            updateVisitorCounts();
        }, 1000);

        // Event handlers for filters and search
        $('#search-input').on('keyup', fetchVisitors);
        $('#dateFilter').change(fetchVisitors);
        $('#statusFilter').change(fetchVisitors);
        $('#buildLoc').change(fetchVisitors);

        // Handle the "Time Out" button click with AJAX
        $('body').on('submit', '.toggle-form', function(e) {
            e.preventDefault();
            
            var form = $(this);
            var visitorId = form.find('input[name="visitor_id"]').val();
            
            $.ajax({
                url: form.attr('action'),
                method: 'POST',
                data: { visitor_id: visitorId },
                success: function(data) {
                    // Update the specific row in the visitor table
                    var row = form.closest('tr');
                    row.find('.status_checked_in').removeClass('status_checked_in').addClass('status_checked_out').text('Checked-Out');
                    row.find('td').eq(10).text(data.time_out); // Update the Time Out column
                    form.remove(); // Remove the Time Out button after it's clicked
                },
                error: function(xhr, status, error) {
                    console.error('Error updating visitor status:', error);
                }
            });
        });

        // Handle Delete Visitor from table list
        $('body').on('submit', '.delete-form', function(e) {
            e.preventDefault();
            var form = $(this);
            var visitorId = form.find('input[name="visitor_id"]').val();
            
            if (confirm('Are you sure you want to delete this visitor?')) {
                $.ajax({
                    url: '/delete_visitor',
                    method: 'POST',
                    data: { visitor_id: visitorId },
                    success: function(response) {
                        fetchVisitors();
                        updateVisitorCounts();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error deleting visitor:', error);
                    }
                });
            }
        });

        // Set the date picker to the current date on page load
        function setDatePickerToCurrentDate() {
            var today = new Date();
            var day = String(today.getDate()).padStart(2, '0');
            var month = String(today.getMonth() + 1).padStart(2, '0');
            var year = today.getFullYear();
            var currentDate = year + '-' + month + '-' + day;

            $('#dateFilter').val(currentDate);
            fetchVisitors();
        }

        setDatePickerToCurrentDate();
        updateVisitorCounts();

        // Modal functionality
        $('body').on('click', '.visitor-link', function(e) {
            e.preventDefault();
            var visitor = $(this).data('visitor');
            $('#modalVisitorId').val(visitor._id);
            showVisitorDetails(visitor);
            $('#visitorModal').show();
        });

        function showVisitorDetails(visitor) {
            var timeIn = moment(visitor.time_in).format('D/M/YYYY h:mm A');
            var timeOut = visitor.time_out ? moment(visitor.time_out).format('D/M/YYYY h:mm A') : '-';
            var visitorDetails = `
                <form id="visitorEditForm">
                    <div class="modal-sec1">
                        <div class="modal-group">
                            <label><strong>Name:</strong></label>
                            <p>${visitor.vis_firstname} ${visitor.vis_lastname}</p>
                            <input type="text" id="modal_vis_firstname" name="vis_firstname" value="${visitor.vis_firstname}" class="modal-input" style="display:none;">
                            <div id="modal_error_firstname" class="error-message"></div>
                            <input type="text" id="modal_vis_lastname" name="vis_lastname" value="${visitor.vis_lastname}" class="modal-input" style="display:none;">
                            <div id="modal_error_lastname" class="error-message"></div>
                        </div>

                        <div class="modal-group">
                            <label><strong>IC Number:</strong></label>
                            <p>${visitor.no_ic}</p>
                            <input type="text" id="modal_no_ic" name="no_ic" value="${visitor.no_ic}" class="modal-input" style="display:none;">
                            <div id="modal_error_no_ic" class="error-message"></div>
                        </div>

                        <div class="modal-group">
                            <label><strong>Address:</strong></label>
                            <p>${visitor.address}</p>
                            <input type="text" id="modal_address" name="address" value="${visitor.address}" class="modal-input" style="display:none;">
                            <div id="modal_error_address" class="error-message"></div>
                        </div>

                        <div class="modal-group">
                            <label><strong>Level:</strong></label>
                            <p>${visitor.level}</p>
                            <input type="text" id="modal_level" name="level" value="${visitor.level}" class="modal-input" style="display:none;">
                            <div id="modal_error_level" class="error-message"></div>
                        </div>

                        <div class="modal-group">
                            <label><strong>No Pas:</strong></label>
                            <p>${visitor.no_pas}</p>
                            <input type="text" id="modal_no_pas" name="no_pas" value="${visitor.no_pas}" class="modal-input" style="display:none;">
                            <div id="modal_error_no_pas" class="error-message"></div>
                        </div>

                        <div class="modal-group">
                            <label><strong>Phone Number:</strong></label>
                            <p>${visitor.no_telephone}</p>
                            <input type="text" id="modal_no_telephone" name="no_telephone" value="${visitor.no_telephone}" class="modal-input" style="display:none;">
                            <div id="modal_error_no_telephone" class="error-message"></div>
                        </div>
                    </div>
                        
                    <div class="modal-sec2">
                        <div class="modal-group">
                            <label><strong>Purpose of Visit:</strong></label>
                            <p class="modal-display">${visitor.pur_visit}</p>
                        </div>

                        <div class="modal-group">
                            <label><strong>Status:</strong></label>
                            <p class="modal-display">${visitor.time_out ? 'Checked-Out' : 'Checked-In'}</p>
                        </div>

                        <div class="modal-group">
                            <label><strong>Time In:</strong></label>
                            <p class="modal-display">${timeIn}</p>
                        </div>

                        <div class="modal-group">
                            <label><strong>Time Out:</strong></label>
                            <p class="modal-display">${timeOut}</p>
                        </div>

                        <div class="modal-group">
                            <label><strong>Building Location:</strong></label>
                            <p class="modal-display">${visitor.build_loc}</p>
                        </div>
                    </div>
                </form>
            `;
            $('#visitorDetails').html(visitorDetails);
        }

        // Edit button for visitor details
        $('#editVisitor').on('click', function() {
            $('#visitorDetails p').hide();
            $('#visitorDetails .modal-input').show();
            $('#visitorDetails .modal-display').show();
            $(this).hide();
            $('#saveChanges').show();
            $('#cancel').show();
        });

        // Save changes button for latest visitor details
        $('#saveChanges').on('click', function() {
            if (!validateModalForm()) {
                return;
            }

            var visitorId = $('#modalVisitorId').val();
            var formData = $('#visitorEditForm').serialize();
            $.ajax({
                url: '/update_visitor/' + visitorId,
                method: 'POST',
                data: formData,
                success: function(response) {
                    $('#visitorModal').hide();
                    fetchVisitors();
                    updateVisitorCounts();
                    $('#saveChanges').hide();
                    $('#editVisitor').show();
                    $('#cancel').hide();
                },
                error: function(xhr, status, error) {
                    console.error('Error updating visitor:', error);
                }
            });
        });

        // Cancel edit button click handler
        $('#cancel').on('click', function() {
            $('#visitorDetails p').show();
            $('#visitorDetails .modal-input').hide();
            $('#editVisitor').show();
            $('#saveChanges').hide();
            $(this).hide();
            isEditing = false;
        });

        // Handle delete action in the modal
        // $('#deleteUser').on('click', function() {
        //     var visitorId = $('#modalVisitorId').val();
        //     $.ajax({
        //         url: '/delete_visitor',
        //         method: 'POST',
        //         data: { visitor_id: visitorId },
        //         success: function(response) {
        //             $('#visitorModal').hide();
        //             fetchVisitors();
        //             updateVisitorCounts();
        //         },
        //         error: function(xhr, status, error) {
        //             console.error('Error deleting visitor:', error);
        //         }
        //     });
        // });

        // Handle Delete Visitor for modal
        $('body').on('submit', '#modalDeleteForm', function(e) {
            e.preventDefault();
            var visitorId = $('#modalVisitorId').val();
            
            if (confirm('Are you sure you want to delete this visitor?')) {
                $.ajax({
                    url: '/delete_visitor',
                    method: 'POST',
                    data: { visitor_id: visitorId },
                    success: function(response) {
                        // Close the modal
                        $('#visitorModal').hide();
                        
                        // Refresh visitor list and update counts
                        fetchVisitors();
                        updateVisitorCounts();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error deleting visitor:', error);
                    }
                });
            }
        });

        // Validation function for the modal form
        function validateModalForm() {
            let valid = true;

            // Clear previous error messages and styles
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.modal-input').forEach(el => {
                el.classList.remove('error', 'valid');
            });

            // Validate first name
            let firstname = document.getElementById('modal_vis_firstname').value;
            if (!/^[a-zA-Z\s]+$/.test(firstname)) {
                valid = false;
                document.getElementById('modal_error_firstname').textContent = "Invalid first name format";
                document.getElementById('modal_vis_firstname').classList.add('error');
            } else {
                document.getElementById('modal_vis_firstname').classList.add('valid');
            }

            // Validate last name
            let lastname = document.getElementById('modal_vis_lastname').value;
            if (!/^[a-zA-Z\s]+$/.test(lastname)) {
                valid = false;
                document.getElementById('modal_error_lastname').textContent = "Invalid last name format";
                document.getElementById('modal_vis_lastname').classList.add('error');
            } else {
                document.getElementById('modal_vis_lastname').classList.add('valid');
            }

            // Validate IC number
            let icNumber = document.getElementById('modal_no_ic').value;
            if (!/^\d{12}$/.test(icNumber)) {
                valid = false;
                document.getElementById('modal_error_no_ic').textContent = "IC number must be 12 digits";
                document.getElementById('modal_no_ic').classList.add('error');
            } else {
                document.getElementById('modal_no_ic').classList.add('valid');
            }

            // Validate address
            let address = document.getElementById('modal_address').value;
            if (address.trim() === "") {
                valid = false;
                document.getElementById('modal_error_address').textContent = "Address is required";
                document.getElementById('modal_address').classList.add('error');
            } else {
                document.getElementById('modal_address').classList.add('valid');
            }

            // Validate level
            let level = document.getElementById('modal_level').value;
            if (!/^\d+$/.test(level)) {
                valid = false;
                document.getElementById('modal_error_level').textContent = "Level must be a number";
                document.getElementById('modal_level').classList.add('error');
            } else {
                document.getElementById('modal_level').classList.add('valid');
            }

            // Validate No Pas
            let noPas = document.getElementById('modal_no_pas').value;
            if (!/^\d+$/.test(noPas)) {
                valid = false;
                document.getElementById('modal_error_no_pas').textContent = "Pas must be a number";
                document.getElementById('modal_no_pas').classList.add('error');
            } else {
                document.getElementById('modal_no_pas').classList.add('valid');
            }

            // Validate phone number
            let phoneNumber = document.getElementById('modal_no_telephone').value;
            if (!/^\d{10,15}$/.test(phoneNumber)) {
                valid = false;
                document.getElementById('modal_error_no_telephone').textContent = "Phone number must be between 10 and 15 digits";
                document.getElementById('modal_no_telephone').classList.add('error');
            } else {
                document.getElementById('modal_no_telephone').classList.add('valid');
            }

            // Validate purpose of visit
            // let purVisit = document.getElementById('modal_pur_visit').value;
            // if (purVisit.trim() === "") {
            //     valid = false;
            //     document.getElementById('modal_error_pur_visit').textContent = "Purpose of visit is required";
            //     document.getElementById('modal_pur_visit').classList.add('error');
            // } else {
            //     document.getElementById('modal_pur_visit').classList.add('valid');
            // }

            return valid;
        }

        //Close the modal when clicking on the "Cancel" button
        $('#close-icon').on('click', function() {
            $('#visitorModal').hide();
        });

        // Close the modal when clicking outside of it
        $(window).on('click', function(event) {
            if (event.target.id === 'visitorModal') {
                $('#visitorModal').hide();
            }
        });
    });
</script>

<%- include('partials/private-footer.ejs') %>
